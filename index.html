<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ACCA TX (UK) FA2024 Ultimate Fix</title>
    <script src="https://cdn.staticfile.org/echarts/5.4.3/echarts.min.js"></script>
    <style>
        /* === åº•å±‚äº¤äº’ä¼˜åŒ– === */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body { 
            margin: 0; padding: 0; overflow: hidden; 
            background-color: #f4f7f6;
            font-family: -apple-system, "PingFang SC", sans-serif;
            /* å…³é”®ä¿®å¤ï¼šç¦æ­¢æµè§ˆå™¨é»˜è®¤æ‰‹åŠ¿ï¼Œå°†æ§åˆ¶æƒå®Œå…¨äº¤ç»™å›¾è¡¨ */
            touch-action: none; 
        }
        
        #main { 
            width: 100vw; height: 100vh; 
            z-index: 1; 
            /* æ¶ˆé™¤ç‚¹å‡»é«˜äº®è‰²å— */
            -webkit-tap-highlight-color: transparent;
        }

        /* === é¡¶éƒ¨æ  === */
        .header {
            position: fixed; top: 0; left: 0; right: 0; height: 55px;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 10;
            display: flex; align-items: center; justify-content: center;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€æ ‡é¢˜æ  */
        }
        .header h1 { 
            font-size: 16px; color: #2c3e50; font-weight: 800; margin: 0; 
            pointer-events: auto; /* æ–‡å­—æœ¬èº«å¯ç‚¹ï¼ˆè™½ç„¶æ²¡åŠŸèƒ½ï¼‰ */
        }
        .header span { 
            background: #1abc9c; color: #fff; font-size: 10px; padding: 2px 6px; 
            border-radius: 4px; margin-left: 8px; 
        }

        /* === åº•éƒ¨è¯¦æƒ…å¼¹çª— (ä¿®å¤æ˜¾ç¤ºå±‚çº§) === */
        .mask {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3); z-index: 99; 
            display: none; opacity: 0; transition: opacity 0.2s;
        }
        .mask.active { display: block; opacity: 1; }

        .sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #fff; z-index: 100;
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -5px 40px rgba(0,0,0,0.1);
            transform: translateY(110%); 
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column; 
            max-height: 80vh; /* ç•™å‡ºé¡¶éƒ¨ç©ºé—´ */
        }
        .sheet.active { transform: translateY(0); }

        /* å¼¹çª—å¤´éƒ¨ */
        .sheet-head {
            padding: 15px 20px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        .sheet-title { font-size: 18px; font-weight: 700; color: #2c3e50; margin: 0; }
        .close-btn { 
            font-size: 24px; color: #999; padding: 5px 10px; cursor: pointer; 
            background: #f5f5f5; border-radius: 50%; width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
        }

        /* å¼¹çª—å†…å®¹ */
        .sheet-body { 
            padding: 20px; overflow-y: auto; -webkit-overflow-scrolling: touch; 
            padding-bottom: 50px; /* åº•éƒ¨ç•™ç™½ */
        }

        /* === å†…å®¹æ’ç‰ˆ (è«å…°è¿ªé£æ ¼) === */
        .block { margin-bottom: 25px; }
        .label { 
            display: inline-block; font-size: 12px; font-weight: 800; 
            color: #fff; padding: 4px 8px; border-radius: 6px; margin-bottom: 8px;
        }
        .text { font-size: 15px; line-height: 1.6; color: #555; text-align: justify; }
        
        .rule-box {
            background: #f8fbfb; border: 1px solid #eef2f3; border-radius: 8px;
            padding: 12px; margin-bottom: 10px;
        }
        .rule-title { font-weight: 700; color: #1abc9c; font-size: 13px; margin-bottom: 4px; }
        
        .case-container {
            background: #fffbf0; border: 1px solid #fcefd0; border-radius: 8px;
            padding: 15px; margin-top: 15px;
        }
        .case-head { font-weight: 700; color: #e67e22; font-size: 14px; margin-bottom: 8px; }
        
        /* æŠ˜å è§£æ */
        details { margin-top: 10px; border-top: 1px dashed #ddd; padding-top: 10px; }
        summary { font-size: 13px; font-weight: 600; color: #3498db; list-style: none; }
        .ans { 
            margin-top: 10px; padding: 10px; background: #fff; 
            font-family: monospace; font-size: 13px; border-radius: 4px; border: 1px solid #eee;
        }

        /* é«˜äº® */
        .hl { color: #c0392b; font-weight: bold; }

    </style>
</head>
<body>

    <div class="header">
        <h1>TX (UK) Guide</h1>
        <span>FA2024</span>
    </div>

    <div id="main"></div>

    <div class="mask" id="mask" onclick="closeSheet()"></div>
    <div class="sheet" id="sheet">
        <div class="sheet-head">
            <div class="sheet-title" id="sheetTitle">Topic</div>
            <div class="close-btn" onclick="closeSheet()">Ã—</div>
        </div>
        <div class="sheet-body" id="sheetContent"></div>
    </div>

    <script type="text/javascript">
        var chartDom = document.getElementById('main');
        var myChart = echarts.init(chartDom, null, {renderer: 'canvas'});

        // ================= 1. è«å…°è¿ªé…è‰² =================
        const c = {
            iht: '#1abc9c',     // è–„è·ç»¿ (IHT)
            iht_sub: '#a8e6cf',
            cgt: '#a29bfe',     // æš®å±±ç´« (CGT)
            cgt_sub: '#dcd6f7',
            root: '#34495e',    // æ·±ç°
            boss: '#fab1a0'     // çŠç‘šç²‰ (BOSS)
        };

        // ================= 2. æ•°æ®å†…å®¹ (å«å®Œæ•´ IHT & CGT) =================
        const nodes = [
            // ROOT
            { id: '0', name: 'ACCA TX\n(UK)', category: 'ROOT', symbolSize: 65, itemStyle: { color: c.root }, info: { def: 'FA2024 æ ¸å¿ƒå¤ä¹ ã€‚ç‚¹å‡»åˆ†æ”¯æŸ¥çœ‹è¯¦æƒ…ã€‚' } },
            
            // IHT
            { id: 'iht', name: 'IHT\né—äº§ç¨', category: 'IHT', symbolSize: 55, itemStyle: { color: c.iht }, info: { def: 'åŸºäºä»·å€¼è½¬ç§»ã€‚', rules: [{t:'NRB', c:'Â£325,000'}, {t:'RNRB', c:'Â£175,000'}, {t:'Death Rate', c:'40%'}] } },
            { id: 'iht_life', name: 'Lifetime\nç”Ÿå‰è½¬ç§»', category: 'IHT', symbolSize: 40, itemStyle: { color: c.iht_sub }, info: { def: 'ç”Ÿå‰ç¤¼ç‰©åˆ†ç±»ã€‚', rules: [{t:'Exempt', c:'Spouse (æ— é™), AE (Â£3k), Small Gifts (Â£250).'}, {t:'PET', c:'ç»™ä¸ªäººã€‚7å¹´å†…å…ç¨ã€‚'}, {t:'CLT', c:'ç»™ä¿¡æ‰˜ã€‚ç«‹äº¤20%ã€‚'}], cases: [{t:'æ¡ˆä¾‹: çˆ·çˆ·é€ç¤¼', s:'é€å­™å­Â£8kç»“å©šç¤¼ç‰©ã€‚', a:'Exemptions: Marriage Â£2.5k, AE Â£6k (2yrs). Tax=0.'}] } },
            { id: 'iht_death', name: 'Death Tax\næ­»åè¿½æº¯', category: 'IHT', symbolSize: 40, itemStyle: { color: c.iht_sub }, info: { def: '7å¹´åŸåˆ™ã€‚', rules: [{t:'NRB', c:'ä½¿ç”¨æ­»æ—¶NRBï¼Œæ‰£é™¤è¯¥ç¤¼ç‰©å‰7å¹´GCTã€‚'}, {t:'Taper', c:'3-4yr(20% off)... 6-7yr(80% off).'}], cases: [{t:'æ¡ˆä¾‹: å¯Œè±ªå»ä¸–', s:'é€å‡ºPET Â£100kå4.5å¹´å»ä¸–ã€‚', a:'Â£100kè¢«NRBè¦†ç›–ï¼Œç¨0ã€‚ä½†NRBå‡å°‘ã€‚'}] } },
            { id: 'iht_estate', name: 'Estate\næ­»äº¡é—äº§', category: 'IHT', symbolSize: 40, itemStyle: { color: c.iht_sub }, info: { def: 'æ­»äº¡èµ„äº§ã€‚', rules: [{t:'RNRB', c:'ä¸»å±…æ‰€+ç›´ç³»åä»£=Â£175kã€‚'}], cases: [{t:'æ¡ˆä¾‹: é—äº§è®¡ç®—', s:'æˆ¿Â£400kç»™å„¿ï¼Œå…¶ä»–Â£200kã€‚', a:'Estate Â£600k - RNRB Â£175k - NRB Â£325k = Taxable Â£100k @ 40%.'}] } },
            { id: 'iht_boss', name: 'IHT BOSS\nç»¼åˆå¤§é¢˜', category: 'IHT', symbolSize: 50, itemStyle: { color: c.boss }, info: { isBoss: true, title:'ğŸ‘¹ IHT: NRB è€—å°½', scen:'Mr. Bond (2026å»ä¸–)ã€‚\n1. 2019 CLT Â£280k\n2. 2021 PET Â£150k\n3. Estate Â£800k (æˆ¿ç»™å„¿)ã€‚', ans:'1. CLTå ç”¨Â£280k NRBã€‚\n2. PETåƒæ‰å‰©ä½™Â£45k NRBå¹¶æº¢å‡ºã€‚\n3. æ­»æ—¶NRB = 0ã€‚\n4. Tax: (Â£775k - Â£175k RNRB) * 40% = Â£240kã€‚' } },

            // CGT
            { id: 'cgt', name: 'CGT\nèµ„æœ¬åˆ©å¾—', category: 'CGT', symbolSize: 55, itemStyle: { color: c.cgt }, info: { def: 'èµ„äº§å¤„ç½®åˆ©å¾—ã€‚', rules: [{t:'AEA', c:'Â£3,000'}, {t:'Resi Rate', c:'18% / 24% (FA24)'}, {t:'Other', c:'10% / 20%'}] } },
            { id: 'cgt_calc', name: 'Compute\nè®¡ç®—', category: 'CGT', symbolSize: 40, itemStyle: { color: c.cgt_sub }, info: { def: 'è®¡ç®—æ¡†æ¶ã€‚', rules: [{t:'Loss', c:'CYå…¨æŠµï¼ŒBFæŠµè‡³AEAã€‚'}, {t:'Chattels', c:'Â£6kè§„åˆ™ã€‚Marginal Reliefã€‚'}], cases: [{t:'æ¡ˆä¾‹: æˆ¿+è‚¡', s:'æˆ¿èµšÂ£20k(High Rate)ï¼Œè‚¡èµšÂ£10kã€‚', a:'AEAæŠµæˆ¿(24%)ã€‚Tax: Â£17k*24% + Â£10k*20%.'}] } },
            { id: 'cgt_boss', name: 'CGT BOSS\nç»¼åˆå¤§é¢˜', category: 'CGT', symbolSize: 50, itemStyle: { color: c.boss }, info: { isBoss: true, title:'ğŸ‘¹ CGT: Mr. Lucky', scen:'å–èŠ±ç“¶èµšÂ£4k(Marginal); å–å…¬å¸èµšÂ£200k(BADR); å–è‚¡ç¥¨èµšÂ£2kã€‚', ans:'1. Vase Â£3,333 (Restricted).\n2. BADR Â£200k @ 10%.\n3. Shares Â£2k @ 20%.\nTotal Tax è®¡ç®—...' } }
        ];

        const links = [
            { source: '0', target: 'iht' }, { source: 'iht', target: 'iht_life' }, { source: 'iht_life', target: 'iht_death' }, { source: 'iht_death', target: 'iht_estate' }, { source: 'iht_estate', target: 'iht_boss' },
            { source: '0', target: 'cgt' }, { source: 'cgt', target: 'cgt_calc' }, { source: 'cgt_calc', target: 'cgt_boss' }
        ];

        // ================= 3. ECharts é…ç½® (è§¦æ§ä¼˜åŒ–) =================
        const option = {
            backgroundColor: 'transparent',
            tooltip: { show: false }, // ç¦ç”¨é»˜è®¤ï¼Œé˜²é®æŒ¡
            series: [{
                type: 'graph',
                layout: 'force',
                data: nodes,
                links: links,
                roam: true, // å…è®¸ç¼©æ”¾
                draggable: true, // å…è®¸æ‹–æ‹½
                zoom: 0.85,
                // å…³é”®ï¼šæ‰©å¤§ç‚¹å‡»å“åº”åŒºåŸŸ
                cursor: 'pointer',
                label: {
                    show: true, position: 'bottom', color: '#555', fontSize: 12, fontWeight: 'bold', formatter: '{b}',
                    distance: 8
                },
                itemStyle: {
                    borderColor: '#fff', borderWidth: 3,
                },
                lineStyle: {
                    color: '#ccc', curveness: 0.2, width: 2, opacity: 0.6
                },
                force: {
                    repulsion: 450, edgeLength: 100, gravity: 0.06, friction: 0.6
                },
                // å…³é”®ï¼šé«˜äº®äº¤äº’
                emphasis: {
                    focus: 'adjacency',
                    scale: true,
                    itemStyle: {
                        shadowBlur: 20, shadowColor: 'rgba(0,0,0,0.5)'
                    }
                }
            }]
        };

        myChart.setOption(option);

        // ================= 4. æ ¸å¿ƒäº¤äº’é€»è¾‘ (ä¿®å¤ç‰ˆ) =================
        
        // ç›‘å¬çª—å£å˜åŒ–
        window.addEventListener('resize', () => myChart.resize());

        // å¼ºåˆ¶ç‚¹å‡»ç›‘å¬ (zr event æ¯” series event æ›´åº•å±‚ï¼Œå“åº”æ›´çµæ•)
        myChart.getZr().on('click', function(params) {
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æœ‰æ•ˆå…ƒç´ 
            const target = params.target;
            if (target && target.dataIndex != null) {
                // è·å–æ•°æ®
                const nodeData = nodes[target.dataIndex];
                if (nodeData && nodeData.info) {
                    openSheet(nodeData);
                }
            } else {
                // ç‚¹å‡»ç©ºç™½å¤„ï¼Œå°è¯•å…³é—­ï¼ˆå¯é€‰ï¼‰
                // closeSheet();
            }
        });

        // å¤‡ç”¨ï¼šæ ‡å‡†çš„ ECharts ç‚¹å‡»äº‹ä»¶ (é˜²æ­¢ zr å¤±æ•ˆ)
        myChart.on('click', function(params) {
            if (params.data && params.data.info) {
                openSheet(params.data);
            }
        });

        function openSheet(node) {
            const info = node.info;
            const color = node.itemStyle.color;

            // å¡«å……å¤´éƒ¨
            document.getElementById('sheetTitle').innerText = node.name.replace('\n', ' ');
            document.getElementById('sheetTitle').style.color = color;

            let html = '';

            if (info.isBoss) {
                // BOSSé¢˜
                html += `<div class="case-container" style="border-color:${color}; background:#fffcf5">
                            <div class="case-head" style="color:#d35400">ğŸ”¥ ${info.title}</div>
                            <div class="text">${info.scen.replace(/\n/g, '<br>')}</div>
                         </div>
                         <details open><summary>ç‚¹å‡»æŸ¥çœ‹è§£æ</summary><div class="ans">${info.ans}</div></details>`;
            } else {
                // æ™®é€šçŸ¥è¯†ç‚¹
                if (info.def) {
                    html += `<div class="block">
                                <span class="label" style="background:${color}">DEFINITION</span>
                                <div class="text">${info.def}</div>
                             </div>`;
                }
                if (info.rules) {
                    html += `<div class="block">`;
                    info.rules.forEach(r => {
                        html += `<div class="rule-box">
                                    <div class="rule-title" style="color:${color}">${r.t}</div>
                                    <div class="text">${r.c}</div>
                                 </div>`;
                    });
                    html += `</div>`;
                }
                if (info.cases) {
                    info.cases.forEach(c => {
                        html += `<div class="case-container">
                                    <div class="case-head" style="color:${color}">ğŸŒ° ${c.t}</div>
                                    <div class="text">${c.s}</div>
                                    <details><summary>æŸ¥çœ‹è§£æ</summary><div class="ans">${c.a}</div></details>
                                 </div>`;
                    });
                }
            }

            document.getElementById('sheetContent').innerHTML = html;
            document.getElementById('mask').classList.add('active');
            document.getElementById('sheet').classList.add('active');
        }

        function closeSheet() {
            document.getElementById('mask').classList.remove('active');
            document.getElementById('sheet').classList.remove('active');
        }

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ACCA TX (UK) IHT Master Guide</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        /* === å…¨å±€æ ·å¼ === */
        :root {
            --primary-color: #1abc9c; /* è–„è·ç»¿ */
            --bg-color: #f4f7f6;
            --text-main: #2c3e50;
            --card-bg: #ffffff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; padding: 0; overflow: hidden; background-color: var(--bg-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; }
        #main { width: 100vw; height: 100vh; }

        /* é¡¶éƒ¨æ  */
        .header {
            position: fixed; top: 0; left: 0; right: 0; height: 50px;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 100;
            display: flex; align-items: center; justify-content: center;
        }
        .header h1 { font-size: 16px; color: var(--primary-color); font-weight: 800; letter-spacing: 1px; margin: 0; }

        /* åº•éƒ¨è¯¦æƒ…å¼¹çª— */
        .sheet-mask {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3); z-index: 199; display: none; opacity: 0; transition: opacity 0.3s;
        }
        .sheet-mask.active { display: block; opacity: 1; }

        .sheet-container {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--card-bg); z-index: 200;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
            transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column; max-height: 85vh;
        }
        .sheet-container.active { transform: translateY(0); }

        /* å¼¹çª—å¤´éƒ¨ */
        .sheet-head {
            padding: 15px 20px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
        }
        .sheet-title { font-size: 18px; font-weight: 800; color: var(--text-main); margin: 0; }
        .close-btn { font-size: 24px; color: #bbb; cursor: pointer; padding: 0 10px; }

        /* å¼¹çª—å†…å®¹åŒº */
        .sheet-body { padding: 20px; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        /* å†…å®¹æ’ç‰ˆç»„ä»¶ */
        .block { margin-bottom: 25px; }
        .block-title { 
            font-size: 14px; font-weight: 800; color: var(--primary-color); 
            margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;
            border-left: 4px solid var(--primary-color); padding-left: 8px;
        }
        
        .text-std { font-size: 15px; line-height: 1.7; color: #555; text-align: justify; }
        .text-std strong { color: #2c3e50; font-weight: 700; }
        .text-std ul { padding-left: 18px; margin: 5px 0; }
        .text-std li { margin-bottom: 5px; }

        /* æ¡ˆä¾‹å¡ç‰‡ */
        .case-card {
            background: #f0fcf9; border: 1px solid #dbece8; border-radius: 8px;
            padding: 15px; margin-top: 10px;
        }
        .case-title { font-size: 13px; font-weight: 800; color: #16a085; margin-bottom: 5px; display: flex; align-items: center; }
        .case-title::before { content: 'ğŸŒ°'; margin-right: 5px; }
        .case-content { font-size: 14px; color: #2c3e50; line-height: 1.6; font-family: "Menlo", sans-serif; white-space: pre-wrap; }

        /* ç»¼åˆå¤§é¢˜æ ·å¼ */
        .boss-card {
            background: #2c3e50; color: #ecf0f1; border-radius: 12px; 
            overflow: hidden; margin-top: 15px;
        }
        .boss-header {
            background: #34495e; padding: 12px 15px; font-weight: 800; 
            font-size: 14px; letter-spacing: 1px; color: #e74c3c;
        }
        .boss-body { padding: 15px; font-size: 13px; line-height: 1.6; font-family: "Menlo", sans-serif; }
        
        /* è¡¨æ ¼æ ·å¼ */
        .tax-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        .tax-table th, .tax-table td { border: 1px solid #7f8c8d; padding: 6px; text-align: left; }
        .tax-table th { background: #34495e; color: #fff; }

    </style>
</head>
<body>

    <div class="header">
        <h1>TX (UK) IHT Master Guide</h1>
    </div>

    <div id="main"></div>

    <div class="sheet-mask" id="mask" onclick="closeSheet()"></div>
    <div class="sheet-container" id="sheet">
        <div class="sheet-head">
            <h2 class="sheet-title" id="sheetTitle">Title</h2>
            <div class="close-btn" onclick="closeSheet()">Ã—</div>
        </div>
        <div class="sheet-body" id="sheetContent">
            </div>
    </div>

    <script type="text/javascript">
        var chartDom = document.getElementById('main');
        var myChart = echarts.init(chartDom);

        // ================= 1. æ•°æ®ç»“æ„ (å®Œå…¨åŸºäºæ‚¨çš„è®²ä¹‰) =================
        const data = [
            {
                id: 'root', name: 'IHT\né—äº§ç¨ä½“ç³»', category: 'ROOT', symbolSize: 80,
                info: {
                    title: 'IHT æ ¸å¿ƒé€»è¾‘',
                    blocks: [
                        {t: 'é€»è¾‘ä¸»çº¿', c: 'IHT çš„é€»è¾‘éå¸¸çº¿æ€§ï¼š<br><b>ç”Ÿå‰è½¬ç§» -> æ­»åè¿½åŠ  -> æ­»äº¡é—äº§</b><br>æŒ‰æ­¤æ—¶é—´è½´è®°å¿†æœ€ç¨³å›ºã€‚'},
                        {t: 'å…³é”®ç¨ç‡ (2025/26)', c: '<ul><li><b>NRB (é›¶ç¨ç‡å¸¦):</b> Â£325,000</li><li><b>RNRB (å±…ä½é›¶ç¨ç‡å¸¦):</b> Â£175,000</li><li><b>Death Rate:</b> 40%</li><li><b>Lifetime Rate:</b> 20% (å—èµ äºº) / 25% (æèµ äºº)</li></ul>'}
                    ]
                }
            },
            {
                id: 'life', name: 'Lifetime\nç”Ÿå‰è½¬ç§»', category: 'NODE', symbolSize: 60,
                info: {
                    title: '2. ç”Ÿå‰è½¬ç§» (Lifetime Transfers)',
                    blocks: [
                        {t: 'A. è±å…è½¬ç§» (Exempt)', c: 'æ— è®ºç”Ÿæ­»ï¼Œæ°¸è¿œä¸å¾ç¨ã€‚<br>â€¢ <b>Spouse:</b> é…å¶é—´æ— é™é¢ã€‚<br>â€¢ <b>AE (å¹´å…):</b> Â£3,000 (å¯ç»“è½¬1å¹´)ã€‚<br>â€¢ <b>Small Gifts:</b> Â£250ã€‚<br>â€¢ <b>Marriage:</b> çˆ¶æ¯Â£5k, ç¥–çˆ¶æ¯Â£2.5k, å…¶ä»–Â£1kã€‚'},
                        {t: 'B. PET (æ½œåœ¨è±å…)', c: 'ä¸ªäºº -> ä¸ªäººã€‚<br>â€¢ ç”Ÿå‰ä¸äº¤ç¨ã€‚<br>â€¢ æ´»è¿‡7å¹´å…¨å…ï¼›7å¹´å†…æ­»è¡¥äº¤ã€‚'},
                        {t: 'C. CLT (åº”ç¨è½¬ç§»)', c: 'ä¸ªäºº -> ä¿¡æ‰˜ã€‚<br>â€¢ ç«‹å³äº¤ç¨: (Value - Exempt - NRB) x 20%ã€‚<br>â€¢ 7å¹´ç´¯ç§¯åŸåˆ™: æ‰£é™¤å‰7å¹´çš„ GCTã€‚'}
                    ],
                    cases: [
                        {t: 'æ¡ˆä¾‹1: ç²¾æ‰“ç»†ç®—çš„çˆ·çˆ·', c: '2024å¹´5æœˆé€å­™å­ç»“å©šç¤¼ç‰© Â£8,000 (ä¸Šå¹´æœªèµ äºˆ)ã€‚\n\nTransfer: Â£8,000\n(-) Marriage (Grandparent): (Â£2,500)\n(-) AE (Current Year): (Â£3,000)\n(-) AE (B/F): (Â£2,500)\n= Chargeable: Â£0 (å®Œå…¨è±å…)'},
                        {t: 'æ¡ˆä¾‹2: å¯Œè±ªçš„ä¿¡æ‰˜ (CLT)', c: 'å‘ä¿¡æ‰˜è½¬å…¥ Â£400,000ã€‚æ­¤å‰æ—  CLTã€‚\n\nGross Transfer: Â£400,000\nLess NRB: (Â£325,000)\nTaxable: Â£75,000\nTax: Â£75,000 x 20% = Â£15,000'}
                    ]
                }
            },
            {
                id: 'death_gift', name: 'Death Tax\næ­»åè¿½æº¯', category: 'NODE', symbolSize: 60,
                info: {
                    title: '3. æ­»äº¡æ—¶çš„é¢å¤–ç¨',
                    blocks: [
                        {t: 'è§¦å‘æ¡ä»¶', c: 'æèµ äººåœ¨é€ç¤¼å <b>7å¹´å†…æ­»äº¡</b>ã€‚ä¹‹å‰çš„ PET å’Œ CLT éœ€è¦é‡ç®—ã€‚'},
                        {t: 'è®¡ç®—æ­¥éª¤', c: '1. æ‰¾å‡ºæ­»å‰7å¹´å†…æ‰€æœ‰ PET/CLTã€‚<br>2. <b>NRBæ‰£é™¤:</b> ä½¿ç”¨æ­»æ—¶ NRB (Â£325k)ï¼Œå‡å»è¯¥ç¤¼ç‰©<b>å†å¾€å‰æ¨7å¹´</b>çš„ GCTã€‚<br>3. <b>Taper Relief:</b> 3-4å¹´(8æŠ˜) ... 6-7å¹´(2æŠ˜)ã€‚<br>4. <b>Credit:</b> å‡å»ç”Ÿå‰å·²äº¤çš„ CLT ç¨ã€‚'}
                    ],
                    cases: [
                        {t: 'æ¡ˆä¾‹3: ä¸å¹¸çš„å¯Œè±ª', c: 'é€å‡º Â£100k PET å 4.5 å¹´å»ä¸– (å‰7å¹´æ— ç¤¼ç‰©)ã€‚\n\nGross Value: Â£100,000\nAvailable NRB: Â£325,000\n(å…¨é¢è¢« NRB è¦†ç›–)\nTax Payable: Â£0\n(ä½†åƒæ‰äº† Â£100k é¢åº¦!)'}
                    ]
                }
            },
            {
                id: 'estate', name: 'Death Estate\næ­»äº¡é—äº§', category: 'NODE', symbolSize: 60,
                info: {
                    title: '4. æ­»äº¡é—äº§ç¨',
                    blocks: [
                        {t: 'A. ä¼°å€¼', c: 'èµ„äº§æŒ‰å¸‚ä»· (Probate Value)ã€‚<br>æ‰£é™¤: å€ºåŠ¡ã€æœªä»˜ç¨æ¬¾ã€ä¸§è‘¬è´¹ã€‚<br>è±å…: ç•™ç»™é…å¶å®Œå…¨å…ç¨ã€‚'},
                        {t: 'B. RNRB (å±…ä½é›¶ç¨ç‡å¸¦)', c: '<b>é‡‘é¢:</b> Â£175,000ã€‚<br><b>æ¡ä»¶:</b> æœ‰ä¸»å±…æ‰€ + ç•™ç»™ç›´ç³»åä»£ (å­å¥³/å­™å­å¥³)ã€‚<br><b>é™åˆ¶:</b> å‡€å€¼ < Â£175k æ—¶å–å‡€å€¼ã€‚'},
                        {t: 'C. NRB è½¬ç§»', c: 'é…å¶æœªç”¨å®Œçš„ NRB/RNRB ç™¾åˆ†æ¯”å¯è½¬ç§»ã€‚'}
                    ],
                    cases: [
                        {t: 'æ¡ˆä¾‹4: æœ€åçš„é—äº§', c: 'ç•™ç»™å­™å­æˆ¿äº§ Â£400kï¼Œå…¶ä»– Â£200kã€‚\n\nChargeable: Â£600,000\nLess RNRB: (Â£175,000)\nLess NRB: (Â£325,000)\nTaxable: Â£100,000\nTax: Â£100,000 x 40% = Â£40,000'}
                    ]
                }
            },
            {
                id: 'proforma', name: 'Proforma\nè®¡ç®—æ¨¡æ¿', category: 'NODE', symbolSize: 60,
                info: {
                    title: '5. å¿…èƒŒè®¡ç®—æ¨¡æ¿',
                    blocks: [
                        {t: 'Step 1: Lifetime Tax (CLT)', c: '<div style="background:#eee;padding:10px;font-family:monospace">Transfer Value\n(Less: Exemptions)\n= Chargeable Transfer\n(Less: NRB - look back 7 yrs)\n= Taxable x 20%/25%</div>'},
                        {t: 'Step 2: Death Tax (Gifts)', c: '<div style="background:#eee;padding:10px;font-family:monospace">Gross Value (at date of gift)\n(Less: NRB at death - look back 7 yrs)\n= Taxable x 40%\n(Less: Taper Relief)\n(Less: Lifetime Tax Paid)</div>'},
                        {t: 'Step 3: Death Estate', c: '<div style="background:#eee;padding:10px;font-family:monospace">Total Assets\n(Less: Debts/Funeral/Spouse)\n= Chargeable Estate\n(Less: RNRB Â£175k)\n(Less: Remaining NRB)\n= Taxable x 40%</div>'}
                    ]
                }
            },
            {
                id: 'boss', name: 'BOSS\nç»¼åˆå¤§é¢˜', category: 'BOSS', symbolSize: 75,
                itemStyle: { color: '#e74c3c', shadowBlur: 20, shadowColor: '#e74c3c' },
                info: {
                    title: 'ğŸ‘¹ ç»ˆæ BOSS æˆ˜',
                    isBoss: true,
                    scen: 'Mr. Bond (2026å¹´3æœˆå»ä¸–)ã€‚\nâ€¢ 2019.8 CLT Â£280k\nâ€¢ 2021.10 PET Â£150k\nâ€¢ Estate: æˆ¿Â£500k(ç»™å„¿), è‚¡Â£300k, å€ºÂ£25kã€‚',
                    steps: [
                        {t: 'Step 1: Check NRB Usage (ç”Ÿå‰å ç”¨)', c: '<b>CLT (2019):</b> Â£280kã€‚æ­»å‰6-7å¹´ï¼Œå ç”¨ NRBã€‚<br><b>PET (2021):</b> Â£150kã€‚æ­»å‰ < 7å¹´ï¼Œå˜æˆ Chargeableã€‚<br><br><b>NRB å‰©ä½™æƒ…å†µ:</b><br>Â£325k - Â£280k (CLT) = Â£45k å‰©ä½™ã€‚<br>PET (Â£150k) åƒæ‰äº†æœ€åçš„ Â£45k å¹¶æº¢å‡ºã€‚<br><b>ç»“è®º: æ­»æ—¶ NRB å·²å½’é›¶ (0)ã€‚</b>'},
                        {t: 'Step 2: Death Estate Tax', c: `
<table class="tax-table">
<tr><td>Total Assets</td><td>800,000</td></tr>
<tr><td>Less: Liabs</td><td>(25,000)</td></tr>
<tr><td><b>Net Estate</b></td><td><b>775,000</b></td></tr>
<tr><td>Less: RNRB</td><td>(175,000)</td></tr>
<tr><td>Less: NRB</td><td>(0)</td></tr>
<tr><td><b>Taxable</b></td><td><b>600,000</b></td></tr>
<tr><td><b>Tax @ 40%</b></td><td><b>240,000</b></td></tr>
</table>`}
                    ]
                }
            }
        ];

        // è¿çº¿ (æ˜Ÿç³»ç»“æ„)
        const links = [
            { source: 'root', target: 'life' },
            { source: 'root', target: 'death_gift' },
            { source: 'root', target: 'estate' },
            { source: 'root', target: 'proforma' },
            { source: 'root', target: 'boss' }
        ];

        // ================= 2. ECharts é…ç½® (ç¾åŒ–) =================
        const option = {
            backgroundColor: 'transparent',
            series: [{
                type: 'graph',
                layout: 'force',
                data: data,
                links: links,
                roam: true, // å…è®¸ç¼©æ”¾
                zoom: 0.85, // åˆå§‹ç¼©æ”¾ï¼Œé€‚åº”æ‰‹æœº
                label: {
                    show: true,
                    position: 'bottom',
                    formatter: '{b}',
                    color: '#7f8c8d',
                    fontSize: 11,
                    fontWeight: 'bold'
                },
                // èŠ‚ç‚¹æ ·å¼: è–„è·ç»¿ä¸»é¢˜
                itemStyle: {
                    color: '#1abc9c', // ç»Ÿä¸€è–„è·ç»¿
                    borderColor: '#fff',
                    borderWidth: 3,
                    shadowBlur: 10,
                    shadowColor: 'rgba(26, 188, 156, 0.3)'
                },
                // è¿çº¿æ ·å¼: æŸ”å’Œæ›²çº¿
                lineStyle: {
                    color: '#bdc3c7',
                    curveness: 0.15,
                    width: 1.5,
                    opacity: 0.6
                },
                // ç‰©ç†å¼•æ“: èˆ’å±•å¸ƒå±€
                force: {
                    repulsion: 400,
                    edgeLength: 110,
                    gravity: 0.05
                }
            }]
        };

        myChart.setOption(option);
        window.addEventListener('resize', () => myChart.resize());

        // ================= 3. äº¤äº’é€»è¾‘ =================
        const mask = document.getElementById('mask');
        const sheet = document.getElementById('sheet');
        const title = document.getElementById('sheetTitle');
        const content = document.getElementById('sheetContent');

        myChart.on('click', function(params) {
            if (params.data.info) openSheet(params.data);
        });

        function openSheet(node) {
            const info = node.info;
            title.innerText = info.title;
            
            let html = '';

            // BOSS é¢˜ç‰¹æ®Šæ¸²æŸ“
            if (info.isBoss) {
                html += `<div class="boss-card">
                            <div class="boss-header">ğŸ”¥ ç»ˆæç»¼åˆé¢˜</div>
                            <div class="boss-body" style="background:#2c3e50; color:#fff">${info.scen.replace(/\n/g, '<br>')}</div>
                         </div>`;
                info.steps.forEach(step => {
                    html += `<div class="block" style="margin-top:15px">
                                <div class="block-title" style="border-color:#e74c3c; color:#e74c3c">${step.t}</div>
                                <div class="text-std">${step.c}</div>
                             </div>`;
                });
            } 
            // æ™®é€šèŠ‚ç‚¹æ¸²æŸ“
            else {
                if (info.blocks) {
                    info.blocks.forEach(b => {
                        html += `<div class="block">
                                    <div class="block-title">${b.t}</div>
                                    <div class="text-std">${b.c}</div>
                                 </div>`;
                    });
                }
                if (info.cases) {
                    info.cases.forEach(c => {
                        html += `<div class="case-card">
                                    <div class="case-title">${c.t}</div>
                                    <div class="case-content">${c.c}</div>
                                 </div>`;
                    });
                }
            }

            content.innerHTML = html;
            mask.classList.add('active');
            sheet.classList.add('active');
        }

        function closeSheet() {
            mask.classList.remove('active');
            sheet.classList.remove('active');
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ACCA TX (UK) IHT Professional Guide</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        /* === è«å…°è¿ªÂ·è–„è·ç»¿ä¸»é¢˜ (ä¸“ä¸šç‰ˆ) === */
        :root {
            --primary: #1abc9c;      /* æ¸…æ–°è–„è· */
            --primary-dark: #16a085; /* æ·±è–„è· */
            --accent: #e67e22;       /* æš–æ©™ (é‡ç‚¹) */
            --bg: #f0f5f4;           /* ææ·¡è–„è·ç°èƒŒæ™¯ */
            --text: #2c3e50;
            --glass: rgba(255, 255, 255, 0.95);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; padding: 0; overflow: hidden; background-color: var(--bg); font-family: -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        #main { width: 100vw; height: 100vh; z-index: 1; }

        /* é¡¶éƒ¨é€šæ  */
        .header {
            position: fixed; top: 0; left: 0; right: 0; height: 50px;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 100;
            display: flex; align-items: center; padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        .header h1 { font-size: 16px; color: var(--primary-dark); font-weight: 700; letter-spacing: 1px; margin: 0; }
        .header .badge { margin-left: 10px; font-size: 10px; background: var(--primary); color: #fff; padding: 2px 6px; border-radius: 4px; }

        /* === è¯¦æƒ…é¢æ¿ (PC/Mobile è‡ªé€‚åº”) === */
        .sheet-mask {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.2); z-index: 199; display: none; transition: opacity 0.3s;
        }
        .sheet-mask.active { display: block; opacity: 1; }

        .sheet-container {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--glass); z-index: 200;
            box-shadow: 0 -5px 40px rgba(26, 188, 156, 0.15);
            transform: translateY(110%); transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            display: flex; flex-direction: column;
            
            /* ç”µè„‘ç«¯ä¼˜åŒ–ï¼šé«˜åº¦é™åˆ¶ï¼Œç•™å‡ºå›¾è°±åŒºåŸŸ */
            max-height: 70vh; 
            border-top: 1px solid rgba(26, 188, 156, 0.2);
        }
        /* æ‰‹æœºç«¯ä¼˜åŒ–ï¼šåœ†è§’ */
        @media (max-width: 768px) {
            .sheet-container { border-radius: 24px 24px 0 0; max-height: 85vh; }
        }
        
        .sheet-container.active { transform: translateY(0); }

        /* é¢æ¿å¤´éƒ¨ */
        .sheet-head {
            padding: 15px 30px; border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.5);
        }
        .sheet-title { font-size: 18px; font-weight: 700; color: var(--text); margin: 0; display: flex; align-items: center; }
        .sheet-title::before { content:''; display:inline-block; width:6px; height:6px; border-radius:50%; background:var(--primary); margin-right:10px; }
        .close-btn { font-size: 24px; color: #95a5a6; cursor: pointer; transition: color 0.2s; }
        .close-btn:hover { color: var(--accent); }

        /* é¢æ¿å†…å®¹åŒº */
        .sheet-body { 
            padding: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; flex: 1;
        }
        /* å†…å®¹å®¹å™¨ï¼šé™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢PCç«¯æ–‡å­—å¤ªé•¿ */
        .content-container {
            max-width: 900px; margin: 0 auto; padding: 30px;
        }

        /* --- å†…å®¹æ’ç‰ˆç»„ä»¶ (Morandi Style) --- */
        
        /* 1. å®šä¹‰å— */
        .concept-box { margin-bottom: 30px; }
        .concept-text { font-size: 15px; line-height: 1.8; color: #555; text-align: justify; }
        
        /* 2. è§„åˆ™åˆ—è¡¨ */
        .rule-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .rule-card {
            background: #fff; border: 1px solid #eef7f5; border-radius: 8px; padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02); transition: transform 0.2s;
        }
        .rule-card:hover { transform: translateY(-2px); border-color: var(--primary); }
        .rule-title { font-size: 12px; font-weight: 800; color: var(--primary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .rule-text { font-size: 14px; color: #333; line-height: 1.5; }

        /* 3. æ¡ˆä¾‹å¡ç‰‡ */
        .case-box {
            background: #f4fbf9; border-left: 4px solid var(--primary); border-radius: 0 8px 8px 0;
            padding: 15px 20px; margin-top: 20px;
        }
        .case-head { font-weight: 700; color: var(--primary-dark); margin-bottom: 8px; font-size: 14px; }
        .case-body { font-size: 14px; color: #444; white-space: pre-wrap; font-family: "Menlo", monospace; line-height: 1.6; }

        /* 4. æŠ˜å è§£æ */
        details { margin-top: 10px; }
        summary {
            cursor: pointer; font-size: 13px; color: #7f8c8d; font-weight: 600;
            padding: 8px 0; list-style: none; user-select: none; outline: none;
        }
        summary:hover { color: var(--primary); }
        summary::marker { display: none; } /* Hide default marker */
        summary::after { content: ' â–¼ ç‚¹å‡»æŸ¥çœ‹è§£æ'; font-size: 12px; opacity: 0.8; }
        details[open] summary::after { content: ' â–² æ”¶èµ·'; }
        
        .analysis {
            background: #fff; border: 1px dashed #dcdcdc; padding: 15px; border-radius: 8px;
            font-family: "Menlo", monospace; font-size: 13px; color: #2c3e50; line-height: 1.6; white-space: pre-wrap;
            animation: fadeIn 0.3s ease;
        }

        /* BOSS é¢˜ç‰¹åˆ«æ ·å¼ */
        .boss-container { border: 2px solid #fceadd; background: #fffcf9; border-radius: 12px; padding: 20px; }
        .boss-title { color: var(--accent); font-weight: 800; margin-bottom: 15px; font-size: 15px; }
        
        /* è¡¨æ ¼ */
        .clean-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        .clean-table th { text-align: left; color: #999; font-weight: 600; border-bottom: 2px solid #eee; padding: 8px; }
        .clean-table td { border-bottom: 1px solid #f5f5f5; padding: 8px; color: #333; }
        .clean-table tr:last-child td { border-bottom: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .hl { background: rgba(26, 188, 156, 0.15); padding: 2px 6px; border-radius: 4px; color: var(--primary-dark); font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <h1>TX (UK) Master Guide</h1>
        <span class="badge">IHT Edition</span>
    </div>

    <div id="main"></div>

    <div class="sheet-mask" id="mask" onclick="closeSheet()"></div>
    <div class="sheet-container" id="sheet">
        <div class="sheet-head">
            <div class="sheet-title" id="sheetTitle">Topic</div>
            <div class="close-btn" onclick="closeSheet()">Ã—</div>
        </div>
        <div class="sheet-body">
            <div class="content-container" id="sheetContent">
                </div>
        </div>
    </div>

    <script type="text/javascript">
        var chartDom = document.getElementById('main');
        var myChart = echarts.init(chartDom, null, {renderer: 'canvas'});

        // ================= æ ¸å¿ƒæ•°æ® (IHT 100% è¿˜åŸ) =================
        const data = [
            // 1. Root
            {
                id: 'root', name: 'IHT\né—äº§ç¨', category: 'ROOT', symbolSize: 45,
                itemStyle: { color: '#1abc9c', shadowBlur: 20, shadowColor: 'rgba(26, 188, 156, 0.5)' },
                info: {
                    def: 'IHT åŸºäº<b>ä»·å€¼è½¬ç§» (Transfer of Value)</b>ï¼Œå³æèµ å¯¼è‡´æèµ è€…è´¢å¯Œå‡å°‘çš„é‡‘é¢ (Diminution in value)ã€‚<br>â€¢ UK Domiciled: å…¨çƒå¾ç¨ã€‚<br>â€¢ Non-UK: ä»…è‹±å›½èµ„äº§ã€‚',
                    rules: [
                        {t: 'Nil Rate Band (NRB)', c: 'Â£325,000'},
                        {t: 'Resi NRB (RNRB)', c: 'Â£175,000'},
                        {t: 'Death Rate', c: '40%'},
                        {t: 'Lifetime Rate', c: '20% (Trustee) / 25% (Donor)'}
                    ]
                }
            },
            // 2. Lifetime
            {
                id: 'life', name: 'Lifetime\nç”Ÿå‰è½¬ç§»', category: 'NODE', symbolSize: 35,
                itemStyle: { color: '#a8e6cf' },
                info: {
                    def: 'ç”Ÿå‰ç¤¼ç‰©åˆ†ä¸º Exempt, PET, CLT ä¸‰ç±»ã€‚',
                    rules: [
                        {t: 'A. Exempt (è±å…)', c: 'â€¢ <b>Spouse:</b> æ— é™é¢ã€‚<br>â€¢ <b>AE:</b> Â£3,000/å¹´ (FIFO, ç»“è½¬1å¹´)ã€‚<br>â€¢ <b>Small Gifts:</b> Â£250ã€‚<br>â€¢ <b>Marriage:</b> çˆ¶æ¯Â£5k, ç¥–çˆ¶æ¯Â£2.5k, å…¶ä»–Â£1kã€‚'},
                        {t: 'B. PET (ä¸ªäºº)', c: 'â€¢ ç”Ÿå‰ä¸äº¤ç¨ã€‚<br>â€¢ æ´»è¿‡7å¹´è±å…ï¼›7å¹´å†…æ­»è¡¥ç¨ã€‚'},
                        {t: 'C. CLT (ä¿¡æ‰˜)', c: 'â€¢ ç«‹å³äº¤ç¨ (Value-Exempt-NRB) x 20%ã€‚<br>â€¢ <b>7å¹´ç´¯ç§¯åŸåˆ™</b>: æ‰£é™¤å‰7å¹´ GCTã€‚'}
                    ],
                    cases: [
                        {t: 'æ¡ˆä¾‹ 1ï¼šç²¾æ‰“ç»†ç®—çš„çˆ·çˆ·', s: '2024å¹´5æœˆé€å­™å­ç»“å©šç¤¼ç‰© Â£8,000 (ä¸Šå¹´æœªèµ äºˆ)ã€‚', a: `Transfer Value: Â£8,000
(-) Marriage Exemption: (Â£2,500) (ç¥–çˆ¶æ¯)
(-) AE (Current Year): (Â£3,000)
(-) AE (Brought Forward): (Â£2,500)
= Chargeable Value: Â£0 (å®Œå…¨è±å…)`},
                        {t: 'æ¡ˆä¾‹ 2ï¼šå¯Œè±ªçš„ä¿¡æ‰˜ (CLT)', s: 'å‘ä¿¡æ‰˜è½¬å…¥ Â£400,000ã€‚æ­¤å‰7å¹´æ—  CLTï¼Œä»…ä¸€ PETã€‚', a: `Gross Chargeable Transfer: Â£400,000
Less NRB: (Â£325,000) (PETä¸å ç”Ÿå‰NRB)
Taxable Amount: Â£75,000
Lifetime Tax: Â£75,000 Ã— 20% = Â£15,000`}
                    ]
                }
            },
            // 3. Death Tax
            {
                id: 'death_gift', name: 'Death Tax\næ­»åè¿½æº¯', category: 'NODE', symbolSize: 35,
                itemStyle: { color: '#a8e6cf' },
                info: {
                    def: 'æ­»å‰ 7 å¹´å†…çš„ PET å’Œ CLT éœ€é‡ç®—ã€‚',
                    rules: [
                        {t: 'æ­¥éª¤', c: '1. æ‰¾å‡ºæ­»å‰7å¹´ç¤¼ç‰©ã€‚<br>2. NRBæ‰£é™¤ (Look back 7 yrs from gift)ã€‚<br>3. å‰©ä½™ x 40%ã€‚'},
                        {t: 'Taper Relief', c: '3-4yr(20%)... 6-7yr(80%) off Taxã€‚'},
                        {t: 'Credit', c: 'å‡å» CLT ç”Ÿå‰å·²äº¤ç¨æ¬¾ã€‚'}
                    ],
                    cases: [
                        {t: 'æ¡ˆä¾‹ 3ï¼šä¸å¹¸çš„å¯Œè±ª', s: 'é€å‡º Â£100k PET å 4.5 å¹´å»ä¸– (å‰7å¹´æ— ç¤¼ç‰©)ã€‚', a: `Gross Value: Â£100,000
Available NRB: Â£325,000
Tax Payable: Â£0
(æ³¨ï¼šä½†è¿™ Â£100k åƒæ‰äº† NRBï¼Œå½±å“åç»­é—äº§ç¨)`}
                    ]
                }
            },
            // 4. Estate
            {
                id: 'estate', name: 'Estate\næ­»äº¡é—äº§', category: 'NODE', symbolSize: 35,
                itemStyle: { color: '#a8e6cf' },
                info: {
                    def: 'å»ä¸–æ—¶èµ„äº§æ€»å€¼ (Probate Value)ã€‚',
                    rules: [
                        {t: 'RNRB Â£175k', c: 'éœ€ï¼šä¸»å±…æ‰€ + ç›´ç³»åä»£ã€‚å‡€å€¼<175kå—é™ã€‚'},
                        {t: 'Spouse Exempt', c: 'ç•™ç»™é…å¶å®Œå…¨å…ç¨ã€‚'},
                        {t: 'Transfer', c: 'æœªç”¨å®Œçš„ NRB/RNRB å¯è½¬ç§»ç»™é…å¶ã€‚'}
                    ],
                    cases: [
                        {t: 'æ¡ˆä¾‹ 4ï¼šæœ€åçš„é—äº§', s: 'Mrs. White å»ä¸–ï¼Œç•™ç»™å­™å­æˆ¿ (Â£400k) + å…¶ä»– (Â£200k)ã€‚æ— èµ äºˆã€‚', a: `Chargeable Estate: Â£600,000
Less RNRB: (Â£175,000)
Less NRB: (Â£325,000)
Taxable: Â£100,000
Tax: Â£100,000 Ã— 40% = Â£40,000`}
                    ]
                }
            },
            // 5. Proforma
            {
                id: 'proforma', name: 'Proforma\næ¨¡æ¿', category: 'NODE', symbolSize: 35,
                itemStyle: { color: '#a8e6cf' },
                info: {
                    def: 'Step 1/2/3 è®¡ç®—æ¨¡æ¿ (èƒŒè¯µ)',
                    proformas: [
                        {t: 'Step 1: Lifetime Tax (CLT)', c: 'Transfer Value\n(Less Exemptions)\n= Chargeable Transfer\n(Less NRB - 7 yrs cumulation)\n= Taxable x 20%/25%'},
                        {t: 'Step 2: Death Tax on Gifts', c: 'Gross Value (at gift date)\n(Less NRB at death - 7 yrs from gift)\n= Taxable x 40%\n(Less Taper Relief)\n(Less Lifetime Tax Paid)'},
                        {t: 'Step 3: Death Estate', c: 'Total Assets\n(Less Debts/Funeral/Spouse)\n= Chargeable Estate\n(Less RNRB)\n(Less Remaining NRB)\n= Taxable x 40%'}
                    ]
                }
            },
            // 6. BOSS
            {
                id: 'boss', name: 'BOSS\nç»¼åˆå¤§é¢˜', category: 'BOSS', symbolSize: 45,
                itemStyle: { color: '#ffd3b6', borderColor: '#fff', borderWidth: 2, shadowBlur: 15, shadowColor: '#e67e22' },
                info: {
                    isBoss: true,
                    title: 'ğŸ‘¹ ç»ˆæ BOSS æˆ˜ï¼šç”Ÿå‰è€—å°½ NRB',
                    scen: 'Mr. Bond (2026å¹´3æœˆå»ä¸–)ã€‚\n1. 2019.8 CLT Â£280k\n2. 2021.10 PET Â£150k\n3. Estate: æˆ¿Â£500k(ç»™å„¿), è‚¡Â£300k, å€ºÂ£25kã€‚',
                    ans: `<b>Step 1: Check NRB Usage</b>
1. CLT (Â£280k): å ç”¨ Â£280k NRBã€‚
   å‰©ä½™ NRB = 325 - 280 = Â£45,000ã€‚
2. PET (Â£150k): å˜æˆ Chargeableã€‚
   åƒæ‰å‰©ä½™ Â£45k NRBã€‚
   <b>ç»“è®ºï¼šæ­»äº¡æ—¶ NRB å·²å½’é›¶ã€‚</b>

<b>Step 2: Death Estate Tax</b>
Total Assets: Â£800,000
Less Debts: (Â£25,000)
<b>Net Estate: Â£775,000</b>

Less RNRB: (Â£175,000) (ç•™ç»™å„¿å­)
Less NRB: (Â£0) (è¢« CLT+PET åƒå…‰)

<b>Taxable: Â£600,000</b>
<b>Tax Due: Â£600,000 Ã— 40% = Â£240,000</b>`
                }
            }
        ];

        const links = [
            { source: 'root', target: 'life' },
            { source: 'root', target: 'death_gift' },
            { source: 'root', target: 'estate' },
            { source: 'root', target: 'proforma' },
            { source: 'root', target: 'boss' },
            { source: 'life', target: 'death_gift' },
            { source: 'death_gift', target: 'estate' }
        ];

        // ================= ECharts é…ç½® =================
        const option = {
            backgroundColor: 'transparent',
            series: [{
                type: 'graph',
                layout: 'force',
                data: data,
                links: links,
                roam: true,
                zoom: 0.9, // é»˜è®¤è§†é‡
                label: {
                    show: true,
                    position: 'bottom',
                    color: '#7f8c8d',
                    fontSize: 11,
                    fontWeight: 'bold',
                    formatter: '{b}',
                    distance: 8
                },
                itemStyle: { borderColor: '#fff', borderWidth: 2 },
                lineStyle: { color: '#dcdcdc', width: 1.5, curveness: 0.15 }, // æç»†ç°çº¿
                force: {
                    repulsion: 600, // æå…¶èˆ’å±•
                    edgeLength: 120,
                    gravity: 0.03
                }
            }]
        };

        myChart.setOption(option);
        window.addEventListener('resize', () => myChart.resize());

        // ================= äº¤äº’é€»è¾‘ =================
        const mask = document.getElementById('mask');
        const sheet = document.getElementById('sheet');
        const titleDom = document.getElementById('sheetTitle');
        const contentDom = document.getElementById('sheetContent');

        myChart.on('click', function(params) {
            if (params.data && params.data.info) openSheet(params.data);
        });

        function openSheet(node) {
            const info = node.info;
            titleDom.innerText = node.name.replace('\n', ' ');
            titleDom.style.color = node.itemStyle.color;

            let html = '';

            // æ™®é€šå†…å®¹æ¸²æŸ“
            if (!info.isBoss) {
                if (info.def) html += `<div class="concept-block"><div class="concept-text">${info.def}</div></div>`;
                
                if (info.rules) {
                    html += `<div class="rule-group">`;
                    info.rules.forEach(r => {
                        html += `<div class="rule-card"><div class="rule-title">${r.t}</div><div class="rule-text">${r.c}</div></div>`;
                    });
                    html += `</div>`;
                }

                if (info.cases) {
                    info.cases.forEach(c => {
                        html += `<div class="case-box">
                                    <div class="case-head">ğŸŒ° ${c.t}</div>
                                    <div class="case-body" style="margin-bottom:8px;">${c.s.replace(/\n/g, '<br>')}</div>
                                    <details><summary></summary><div class="analysis">${c.a}</div></details>
                                 </div>`;
                    });
                }

                if (info.proformas) {
                    info.proformas.forEach(p => {
                        html += `<div class="case-box" style="border-color:#7f8c8d">
                                    <div class="case-head" style="color:#2c3e50">${p.t}</div>
                                    <div class="analysis" style="background:#f9f9f9;border:none">${p.c}</div>
                                 </div>`;
                    });
                }
            } 
            // BOSSé¢˜æ¸²æŸ“
            else {
                html += `<div class="boss-container">
                            <div class="boss-title">${info.title}</div>
                            <div class="case-body">${info.scen.replace(/\n/g, '<br>')}</div>
                            <details open>
                                <summary style="color:#d35400">è§£æè¿‡ç¨‹</summary>
                                <div class="analysis" style="background:#fff; border-color:#fcefd0">${info.ans}</div>
                            </details>
                         </div>`;
            }

            contentDom.innerHTML = html;
            mask.classList.add('active');
            sheet.classList.add('active');
        }

        function closeSheet() {
            mask.classList.remove('active');
            sheet.classList.remove('active');
        }
    </script>
</body>
</html>

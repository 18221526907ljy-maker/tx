<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ACCA TX (UK) IHT Morandi Guide</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        /* === è«å…°è¿ªç¾å­¦ CSS === */
        :root {
            /* è«å…°è¿ªè‰²ç›˜ */
            --bg-color: #fdfcf8;       /* æš–è°ƒå¥¶æ²¹ç™½èƒŒæ™¯ */
            --mint-light: #dcedc1;     /* å«©èŠ½ç»¿ */
            --mint-main: #a8e6cf;      /* è–„è·ç»¿ */
            --sage-green: #81b29a;     /* é¼ å°¾è‰ç»¿ (æ·±è‰²æ–‡å­—/é‡ç‚¹) */
            --sand: #ffd3b6;           /* æš–æ²™è‰² (å¼ºè°ƒ) */
            --text-main: #5d5c61;      /* æŸ”å’Œæ·±ç° */
            --text-light: #888;        /* æµ…ç° */
            --border-color: #f0f0f0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            margin: 0; padding: 0; overflow: hidden; 
            background-color: var(--bg-color); 
            font-family: "Gill Sans", "Gill Sans MT", Calibri, sans-serif; /* æ›´ä¼˜é›…çš„å­—ä½“ */
        }
        #main { width: 100vw; height: 100vh; }

        /* é¡¶éƒ¨æç®€å¯¼èˆª */
        .header {
            position: fixed; top: 0; left: 0; right: 0; height: 50px;
            background: rgba(253, 252, 248, 0.9); backdrop-filter: blur(5px);
            z-index: 100; display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid rgba(0,0,0,0.03);
        }
        .header h1 { 
            font-size: 15px; color: var(--sage-green); 
            font-weight: 600; letter-spacing: 2px; margin: 0; 
            text-transform: uppercase;
        }

        /* åº•éƒ¨è¯¦æƒ…å¡ç‰‡ (æ ¸å¿ƒ) */
        .sheet-mask {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(93, 92, 97, 0.15); /* ææ·¡é®ç½© */
            z-index: 199; display: none; transition: opacity 0.4s;
        }
        .sheet-mask.active { display: block; opacity: 1; }

        .sheet-container {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #fff; z-index: 200;
            border-top-left-radius: 30px; border-top-right-radius: 30px;
            box-shadow: 0 -10px 60px rgba(129, 178, 154, 0.15); /* ç»¿è‰²ç³»æŸ”å…‰é˜´å½± */
            transform: translateY(110%); transition: transform 0.4s cubic-bezier(0.2, 0.9, 0.3, 1.1);
            display: flex; flex-direction: column; max-height: 80vh;
        }
        .sheet-container.active { transform: translateY(0); }

        /* å¡ç‰‡å¤´éƒ¨ */
        .sheet-head {
            padding: 20px 25px 10px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .sheet-title { font-size: 20px; font-weight: 600; color: var(--text-main); margin: 0; }
        .close-btn {
            width: 30px; height: 30px; background: #f2f6f5; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; color: var(--sage-green); cursor: pointer;
        }

        /* å†…å®¹æ»šåŠ¨åŒº */
        .sheet-body { padding: 10px 25px 40px; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        /* --- è«å…°è¿ªå†…å®¹ç»„ä»¶ --- */
        
        /* 1. æ ¸å¿ƒå®šä¹‰å— */
        .concept-block { margin-bottom: 20px; border-left: 3px solid var(--mint-main); padding-left: 12px; }
        .concept-text { font-size: 14px; line-height: 1.8; color: #666; text-align: justify; }
        
        /* 2. è§„åˆ™èƒ¶å›Š */
        .rule-tag { 
            display: inline-block; background: #eef7f2; color: var(--sage-green);
            padding: 4px 10px; border-radius: 12px; font-size: 12px; margin: 0 5px 5px 0; font-weight: 500;
        }

        /* 3. æ¡ˆä¾‹å¡ç‰‡ (æŸ”å’Œç‰ˆ) */
        .case-card {
            background: #fff; border: 1px solid #f0f0f0; border-radius: 16px;
            padding: 18px; margin-top: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.02);
        }
        .case-header { 
            font-size: 13px; font-weight: 700; color: var(--sage-green); 
            margin-bottom: 8px; letter-spacing: 0.5px;
        }
        .case-text { font-size: 14px; color: #555; line-height: 1.6; margin-bottom: 10px;}

        /* 4. æŠ˜å è§£æ (æ ¸å¿ƒäº¤äº’) */
        details { 
            background: #fdfdfd; border-radius: 10px; 
            border: 1px solid #f5f5f5; overflow: hidden; transition: all 0.3s;
        }
        details[open] { background: #fafffd; border-color: var(--mint-main); }
        
        summary {
            padding: 12px 15px; cursor: pointer; font-size: 13px; color: #888;
            font-weight: 500; list-style: none; display: flex; justify-content: space-between; align-items: center;
        }
        summary::after { content: 'è§£æ â–¾'; color: var(--mint-main); }
        details[open] summary::after { content: 'æ”¶èµ· â–´'; }
        
        .analysis-content {
            padding: 15px; border-top: 1px dashed #eee;
            font-family: "Menlo", monospace; font-size: 13px; color: #444; line-height: 1.7;
            background: rgba(168, 230, 207, 0.05); /* ææ·¡è–„è·åº•è‰² */
        }
        
        /* é«˜äº® */
        .hl { color: var(--sage-green); font-weight: bold; }
        .hl-num { background: #fff3cd; padding: 0 4px; border-radius: 2px; color: #b7950b; }

    </style>
</head>
<body>

    <div class="header">
        <h1>IHT Â· MASTER GUIDE</h1>
    </div>

    <div id="main"></div>

    <div class="sheet-mask" id="mask" onclick="closeSheet()"></div>
    <div class="sheet-container" id="sheet">
        <div class="sheet-head">
            <h2 class="sheet-title" id="nodeTitle">Title</h2>
            <div class="close-btn" onclick="closeSheet()">Ã—</div>
        </div>
        <div class="sheet-body" id="sheetContent">
            </div>
    </div>

    <script type="text/javascript">
        var chartDom = document.getElementById('main');
        var myChart = echarts.init(chartDom);

        // ================= è«å…°è¿ªé…è‰² =================
        const c = {
            root: '#81b29a', // é¼ å°¾è‰ç»¿
            sub: '#a8e6cf',  // è–„è·ç»¿
            leaf: '#ffd3b6', // æš–æ²™è‰² (BOSSé¢˜ä¸“ç”¨)
            line: '#dcdcdc'  // æç»†ç°çº¿
        };

        // ================= æ·±åº¦å†…å®¹åº“ (V10.0) =================
        // å®Œå…¨æŒ‰ç…§æ‚¨æä¾›çš„ IHT æ–‡æœ¬è¿›è¡Œè§£æå¡«å……
        const data = [
            // 1. ROOT
            {
                id: 'root', name: 'IHT\né—äº§ç¨', category: 'ROOT', symbolSize: 55,
                itemStyle: { color: c.root, borderColor: '#fff', borderWidth: 3, shadowBlur: 10, shadowColor: c.root },
                info: {
                    def: 'Inheritance Tax (IHT) æ˜¯é’ˆå¯¹ä»·å€¼è½¬ç§» (Transfer of Value) å¾æ”¶çš„ç¨ã€‚',
                    rules: [
                        {t: 'Nil Rate Band (NRB)', c: 'Â£325,000'},
                        {t: 'Resi NRB (RNRB)', c: 'Â£175,000'},
                        {t: 'Death Rate', c: '40%'}
                    ],
                    case: {
                        t: 'å­¦ä¹ é€»è¾‘',
                        s: 'IHT çš„è®¡ç®—å¿…é¡»éµå¾ªä¸¥æ ¼çš„æ—¶é—´è½´ï¼š\n1. ç”Ÿå‰ (Lifetime) -> 2. æ­»åè¿½æº¯ (Death Tax on Gifts) -> 3. é—äº§ (Death Estate)ã€‚',
                        a: 'ç‚¹å‡»å‘¨å›´çš„å°åœ†ç‚¹ï¼ŒæŒ‰é¡ºåºå­¦ä¹ ã€‚'
                    }
                }
            },

            // 2. ç”Ÿå‰è½¬ç§»
            {
                id: 'life', name: 'Lifetime\nç”Ÿå‰è½¬ç§»', category: 'SUB', symbolSize: 40,
                itemStyle: { color: c.sub },
                info: {
                    def: 'ç”Ÿå‰é€å‡ºçš„ç¤¼ç‰©ï¼Œåˆ†ä¸º Exempt (è±å…), PET (æ½œåœ¨è±å…), CLT (åº”ç¨) ä¸‰ç±»ã€‚',
                    rules: [
                        {t: 'AE (å¹´å…)', c: 'Â£3,000/å¹´ (FIFO, ç»“è½¬1å¹´)'},
                        {t: 'Marriage', c: 'çˆ¶æ¯Â£5k / ç¥–çˆ¶æ¯Â£2.5k / å…¶ä»–Â£1k'},
                        {t: 'Small Gifts', c: 'Â£250/äºº (ä¸å¯ä¸AEæ··ç”¨)'}
                    ],
                    case: {
                        t: 'æ¡ˆä¾‹ 1ï¼šç²¾æ‰“ç»†ç®—çš„çˆ·çˆ· (Exemptions)',
                        s: 'Grandpa åœ¨ 2024å¹´5æœˆé€ç»™å­™å­ Â£8,000 ç»“å©šç¤¼ç‰©ã€‚\nä¸Šä¸€ç¨å¹´ (23/24) æœªåšä»»ä½•èµ äºˆã€‚',
                        a: `<b>Step 1: Identify Transfer</b>
Value = Â£8,000 (Cash)

<b>Step 2: Deduct Exemptions</b>
Less: Marriage Exemption (Grandparent) = (Â£2,500)
Less: AE 24/25 (Current Year) = (Â£3,000)
Less: AE 23/24 (Brought Forward) = (Â£2,500)

<b>Step 3: Result</b>
Chargeable Value = <b>Â£0</b>
(å®Œå…¨è±å…ï¼Œä¸æ¶ˆè€— NRB)`
                    }
                }
            },
            {
                id: 'clt', name: 'CLT\nä¿¡æ‰˜èµ ä¸', category: 'SUB', symbolSize: 40,
                itemStyle: { color: c.sub },
                info: {
                    def: 'Chargeable Lifetime Transfer (CLT)ã€‚é€šå¸¸æŒ‡é€ç»™ä¿¡æ‰˜çš„ç¤¼ç‰©ã€‚',
                    rules: [
                        {t: 'è§„åˆ™', c: 'ç”Ÿå‰ç«‹å³å¾ç¨ã€‚è¶…å‡º NRB éƒ¨åˆ†äº¤ 20% (Trustee) æˆ– 25% (Donor)ã€‚'},
                        {t: '7å¹´ç´¯ç§¯', c: 'è®¡ç®—å‰©ä½™ NRB æ—¶ï¼Œè¦æ‰£é™¤æ­¤å‰ 7 å¹´å†…çš„æ‰€æœ‰ GCTã€‚'}
                    ],
                    case: {
                        t: 'æ¡ˆä¾‹ 2ï¼šå¯Œè±ªçš„ä¿¡æ‰˜ (Lifetime Tax)',
                        s: 'Mr. Rich å‘ä¿¡æ‰˜è½¬å…¥ Â£400,000 (CLT)ã€‚Donor æ”¯ä»˜ç¨æ¬¾ã€‚\næ­¤å‰ 7 å¹´å†…æ—  CLTï¼Œåªæœ‰ä¸€ä¸ª PET (ä¸å½±å“ç”Ÿå‰ NRB)ã€‚',
                        a: `<b>Step 1: Chargeable Transfer</b>
Â£400,000 - Â£6,000 (2 years AE) = Â£394,000

<b>Step 2: Available NRB</b>
NRB = Â£325,000
Less: GCTs in prev 7 years = Â£0 (PETs ignored for lifetime tax)
Available = Â£325,000

<b>Step 3: Tax Calculation</b>
Taxable Amount = 394,000 - 325,000 = Â£69,000
Tax @ 25% (Donor pays) = 69,000 x 25% = <b>Â£17,250</b>`
                    }
                }
            },

            // 3. æ­»åè¿½æº¯
            {
                id: 'death_gift', name: 'Death Tax\næ­»åè¿½æº¯', category: 'SUB', symbolSize: 40,
                itemStyle: { color: c.sub },
                info: {
                    def: 'æèµ äººæ­»å‰ 7 å¹´å†…çš„ PET å’Œ CLT éœ€é‡ç®—ã€‚',
                    rules: [
                        {t: 'Taper Relief', c: '3-4yr(20%)... 6-7yr(80%) off Tax'},
                        {t: 'Look Back', c: 'NRB æ‰£é™¤æ—¶ï¼Œå¾€ç¤¼ç‰©æ—¥æœŸçš„å‰7å¹´çœ‹ã€‚'}
                    ],
                    case: {
                        t: 'æ¡ˆä¾‹ 3ï¼šä¸å¹¸çš„å¯Œè±ª (Additional Tax)',
                        s: 'æ¥ä¸Šä¾‹ï¼ŒMr. Rich åœ¨é€å‡º Â£100,000 PET çš„ 4.5 å¹´åå»ä¸–ã€‚\nè¯¥ PET å‰ 7 å¹´æ— å…¶ä»–ç¤¼ç‰©ã€‚',
                        a: `<b>1. Gross Value:</b> Â£100,000 (at date of gift)

<b>2. Nil Rate Band at Death:</b>
Max NRB = Â£325,000
Less: Gifts 7 years prior to THIS PET = Â£0
Available = Â£325,000

<b>3. Tax:</b>
Â£100,000 fully covered by NRB.
Tax = <b>Â£0</b>.
(æ³¨æ„ï¼šè™½ç„¶æ²¡äº¤ç¨ï¼Œä½†è¿™ Â£100k è€—æ‰äº†æ­»æ—¶çš„ NRBï¼Œç•™ç»™é—äº§çš„ NRB å˜å°‘äº†)`
                    }
                }
            },

            // 4. é—äº§
            {
                id: 'estate', name: 'Estate\næ­»äº¡é—äº§', category: 'SUB', symbolSize: 40,
                itemStyle: { color: c.sub },
                info: {
                    def: 'å»ä¸–æ—¶æ‹¥æœ‰çš„èµ„äº§æ€»å€¼ (Probate Value)ã€‚',
                    rules: [
                        {t: 'RNRB', c: 'Â£175,000 (ä¸»å±…æ‰€+ç›´ç³»åä»£)'},
                        {t: 'Transfers', c: 'é…å¶é—´æœªç”¨å®Œçš„ NRB/RNRB å¯è½¬ç§» (Transferable)ã€‚'}
                    ],
                    case: {
                        t: 'æ¡ˆä¾‹ 4ï¼šæœ€åçš„é—äº§ (RNRB)',
                        s: 'Mrs. White å»ä¸–ï¼Œç•™ç»™å­™å­ä¸€å¥—æˆ¿ (Â£400k) å’Œå…¶ä»–èµ„äº§ (Â£200k)ã€‚æ— ç”Ÿå‰èµ äºˆã€‚',
                        a: `<b>1. Chargeable Estate</b>
Â£400k + Â£200k = Â£600,000

<b>2. Exemptions</b>
Less: RNRB (Â£175,000) -> ç¬¦åˆæ¡ä»¶
Less: NRB (Â£325,000) -> å®Œæ•´å¯ç”¨

<b>3. Taxable</b>
600,000 - 500,000 = Â£100,000

<b>4. Tax</b>
Â£100,000 x 40% = <b>Â£40,000</b>`
                    }
                }
            },

            // 5. BOSS
            {
                id: 'boss', name: 'BOSS\nç»¼åˆå¤§é¢˜', category: 'LEAF', symbolSize: 50,
                itemStyle: { color: c.leaf, borderColor: '#fff', borderWidth: 2, shadowBlur: 15, shadowColor: c.leaf },
                info: {
                    def: 'ç»ˆæç»¼åˆè®¡ç®—ï¼šç”Ÿå‰è€—å°½ NRB çš„æƒ…å†µã€‚',
                    rules: [
                        {t: '7 Year Cumulation', c: 'ç”Ÿå‰ç¤¼ç‰©ä¼šåƒæ‰æ­»äº¡æ—¶çš„ NRB'}
                    ],
                    case: {
                        t: 'ğŸ‘¹ ç»ˆæ BOSS æˆ˜',
                        s: 'Mr. Bond (2026å¹´3æœˆå»ä¸–)ã€‚\n1. 2019.8 CLT Â£280k (Gross)\n2. 2021.10 PET Â£150k\n3. Estate: æˆ¿Â£500k(ç»™å„¿å­), è‚¡Â£300k, å€ºÂ£25kã€‚',
                        a: `<b>Step 1: Check NRB Usage (Gift Timeline)</b>
1. CLT (6-7å¹´å‰): Â£280,000
   -> å ç”¨ Â£280k NRBã€‚
   -> å‰©ä½™ NRB = 325 - 280 = Â£45,000ã€‚

2. PET (<7å¹´å‰): Â£150,000
   -> å˜æˆ Chargeableã€‚
   -> åƒæ‰å‰©ä½™çš„ Â£45,000 NRBã€‚
   -> <b>ç»“è®ºï¼šæ­»äº¡æ—¶ NRB å·²å½’é›¶ (0)ã€‚</b>

<b>Step 2: Death Estate Tax</b>
Total Assets: Â£800,000
Less: Debts: (Â£25,000)
Net Estate: <b>Â£775,000</b>

Less: RNRB: (Â£175,000) (æˆ¿ç»™å„¿, OK)
Less: Remaining NRB: (Â£0) (è¢« CLT+PET åƒå…‰äº†!)

Taxable Estate: Â£600,000
Tax Due: Â£600,000 x 40% = <b>Â£240,000</b>`
                    }
                }
            }
        ];

        const links = [
            { source: 'root', target: 'life' },
            { source: 'root', target: 'death_gift' },
            { source: 'root', target: 'estate' },
            { source: 'root', target: 'boss' },
            { source: 'life', target: 'clt' } // è¿æ¥ CLT åˆ° Life
        ];

        // ================= ECharts é…ç½® =================
        const option = {
            backgroundColor: 'transparent',
            series: [{
                type: 'graph',
                layout: 'force',
                data: data,
                links: links,
                roam: true,
                zoom: 0.9,
                label: {
                    show: true,
                    position: 'bottom',
                    color: '#81b29a', // é¼ å°¾è‰ç»¿æ–‡å­—
                    fontSize: 11,
                    fontWeight: 600,
                    fontFamily: 'Gill Sans',
                    formatter: '{b}',
                    distance: 8
                },
                lineStyle: {
                    color: '#dcdcdc', // æç»†ç°çº¿
                    curveness: 0.2,
                    width: 1
                },
                force: {
                    repulsion: 250,
                    edgeLength: 90,
                    gravity: 0.08
                }
            }]
        };

        myChart.setOption(option);
        window.addEventListener('resize', () => myChart.resize());

        // ================= äº¤äº’é€»è¾‘ =================
        const mask = document.getElementById('mask');
        const sheet = document.getElementById('sheet');
        const title = document.getElementById('nodeTitle');
        const content = document.getElementById('sheetContent');

        myChart.on('click', function(params) {
            if (params.data && params.data.info) {
                openSheet(params.data);
            }
        });

        function openSheet(node) {
            const info = node.info;
            const color = node.itemStyle.color;

            // å¤´éƒ¨
            title.innerText = node.name.replace('\n', ' ');
            title.style.color = color === c.leaf ? '#e09f7d' : '#81b29a'; // BOSSé¢˜ç‰¹æ®Šè‰²

            let html = '';

            // 1. å®šä¹‰
            html += `<div class="concept-block" style="border-color:${color}">
                        <div class="concept-text">${info.def}</div>
                     </div>`;

            // 2. è§„åˆ™
            if (info.rules) {
                html += `<div style="margin-bottom:20px">`;
                info.rules.forEach(r => {
                    html += `<span class="rule-tag">${r.t}</span>`;
                });
                html += `</div>`;
            }

            // 3. æ ¸å¿ƒæ¡ˆä¾‹ (å¸¦æŠ˜å )
            if (info.case) {
                html += `<div class="case-card">
                            <div class="case-header">${info.case.t}</div>
                            <div class="case-text" style="white-space:pre-wrap">${info.case.s}</div>
                            <details>
                                <summary>ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†è§£æ</summary>
                                <div class="analysis-content">${info.case.a}</div>
                            </details>
                         </div>`;
            }

            content.innerHTML = html;
            mask.classList.add('active');
            sheet.classList.add('active');
        }

        function closeSheet() {
            mask.classList.remove('active');
            sheet.classList.remove('active');
        }
    </script>
</body>
</html>

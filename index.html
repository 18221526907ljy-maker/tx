<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ACCA TX (UK) FA2024 ç»ˆæè®²ä¹‰å›¾è°±</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* === ç§»åŠ¨ç«¯æ²‰æµ¸å¼æ’ç‰ˆ === */
        :root {
            --bg-color: #f7f5f0; /* è«å…°è¿ªç±³ç™½ */
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --accent-it: #ffb7b2; /* Income Tax */
            --accent-ct: #a8d8ea; /* Corp Tax */
            --accent-cgt: #aa96da; /* CGT */
            --accent-iht: #95e1d3; /* IHT */
            --accent-vat: #ffeaa7; /* VAT */
        }

        body { margin: 0; padding: 0; overflow: hidden; background-color: var(--bg-color); font-family: -apple-system, "PingFang SC", sans-serif; -webkit-tap-highlight-color: transparent; }
        #main { width: 100vw; height: 100vh; }

        /* é¡¶éƒ¨å¯¼èˆª */
        .header {
            position: absolute; top: 0; left: 0; right: 0; z-index: 10;
            padding: 15px 20px; background: rgba(247, 245, 240, 0.9);
            backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { margin: 0; font-size: 18px; color: var(--text-main); font-weight: 800; letter-spacing: -0.5px; }
        .header .badge { background: #2d3436; color: #fff; padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; }

        /* åº•éƒ¨è¯¦æƒ…å¡ç‰‡ (Bottom Sheet) */
        .sheet-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3); z-index: 99; display: none;
            backdrop-filter: blur(4px); transition: opacity 0.3s;
        }
        .sheet-overlay.active { display: block; animation: fadeIn 0.3s; }

        .sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--card-bg); border-radius: 24px 24px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15); z-index: 100;
            height: 85vh; display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .sheet.active { transform: translateY(0); }

        /* å¡ç‰‡å¤´éƒ¨ä¸å†…å®¹ */
        .sheet-header { 
            padding: 20px 25px; border-bottom: 1px solid #f0f0f0; 
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; 
        }
        .sheet-tag { font-size: 10px; font-weight: 800; letter-spacing: 1px; padding: 4px 8px; border-radius: 4px; color: #fff; margin-bottom: 5px; display: inline-block; }
        .sheet-title { margin: 0; font-size: 22px; font-weight: 700; color: var(--text-main); }
        .close-btn { width: 32px; height: 32px; background: #f5f6fa; border-radius: 50%; text-align: center; line-height: 32px; color: #b2bec3; font-size: 20px; }

        .sheet-body { padding: 25px; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        /* å†…å®¹æ’ç‰ˆæ ·å¼ (è®²ä¹‰é£æ ¼) */
        .lecture-block { margin-bottom: 30px; }
        .lecture-title { 
            font-size: 15px; font-weight: 800; color: var(--text-main); 
            border-left: 4px solid; padding-left: 10px; margin-bottom: 15px; 
            display: flex; align-items: center;
        }
        .text-content { font-size: 14px; line-height: 1.7; color: #555; text-align: justify; }
        .text-content li { margin-bottom: 8px; }
        .text-content strong { color: #2c3e50; font-weight: 700; }
        
        /* é‡ç‚¹é«˜äº® */
        .highlight { background: #fff3cd; padding: 0 4px; border-radius: 4px; color: #856404; font-weight: bold; }
        .rate-badge { background: #e8f5e9; color: #2e7d32; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-weight: bold; }

        /* ç»¼åˆé¢˜æ ·å¼ */
        .exam-box { border: 1px solid #eee; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-top: 10px; }
        .exam-header { background: #fdf0ed; padding: 12px 20px; border-bottom: 1px solid #fae3de; font-weight: 700; color: #c0392b; font-size: 14px; }
        .exam-body { padding: 20px; background: #fff; font-size: 14px; line-height: 1.6; color: #333; }
        
        /* æŠ˜å è§£æ */
        details { margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 15px; }
        summary { font-size: 14px; font-weight: 700; color: #2980b9; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; }
        summary::after { content: 'æŸ¥çœ‹è§£æ â–¼'; font-size: 12px; color: #95a5a6; }
        details[open] summary::after { content: 'æ”¶èµ· â–²'; }
        
        .solution-area { background: #f4faff; padding: 15px; border-radius: 8px; margin-top: 15px; font-family: 'Menlo', monospace; font-size: 13px; color: #2c3e50; border: 1px solid #d6eaf8; white-space: pre-wrap; }
        .lecturer-note { margin-top: 12px; padding: 12px; background: #fff8e1; border-radius: 6px; color: #d35400; font-size: 13px; font-style: italic; border: 1px solid #ffe0b2; }

        @keyframes fadeIn { from {opacity:0} to {opacity:1} }
    </style>
</head>
<body>

    <div class="header">
        <h1>TX (UK) Master Guide</h1>
        <span class="badge">FA2024 | 25/26</span>
    </div>

    <div id="main"></div>

    <div class="sheet-overlay" id="overlay" onclick="closeSheet()"></div>
    <div class="sheet" id="sheet">
        <div class="sheet-header">
            <div>
                <span class="sheet-tag" id="sheetTag">CATEGORY</span>
                <h2 class="sheet-title" id="sheetTitle">Title</h2>
            </div>
            <div class="close-btn" onclick="closeSheet()">Ã—</div>
        </div>
        <div class="sheet-body" id="sheetContent">
            </div>
    </div>

    <script type="text/javascript">
        var chartDom = document.getElementById('main');
        var myChart = echarts.init(chartDom);

        // ================= æ ¸å¿ƒå†…å®¹åº“ (FA2024) =================
        const dataPoints = [
            {
                id: 'root', name: 'UK TAX SYSTEM', category: 'System', color: '#34495e', symbolSize: 90,
                content: {
                    intro: 'FA2024 æ ¸å¿ƒå˜åŒ–æ‘˜è¦ (é€‚ç”¨äº 25/26 è€ƒå­£)',
                    sections: [
                        { title: '1. NIC è´¹ç‡å·¨å˜', content: 'Class 1 Employee é™è‡³ <b>8%</b> (åŸ10/12%)ã€‚<br>Class 4 Self-Employed é™è‡³ <b>6%</b> (åŸ9%)ã€‚' },
                        { title: '2. CGT ç´§ç¼©', content: 'å¹´åº¦å…ç¨é¢ (AEA) ä»…å‰© <b>Â£3,000</b>ã€‚<br>ä½å®…æˆ¿äº§é«˜ç¨ç‡é™è‡³ <b>24%</b> (åŸ28%)ã€‚' },
                        { title: '3. VAT é—¨æ§›', content: 'æ³¨å†Œé—¨æ§›ä¸Šè°ƒè‡³ <b>Â£90,000</b>ã€‚<br>æ³¨é”€é—¨æ§›ä¸Šè°ƒè‡³ <b>Â£88,000</b>ã€‚' }
                    ]
                }
            },
            // ================= 1. Income Tax =================
            {
                id: 'it', name: 'Income Tax\nä¸ªäººæ‰€å¾—ç¨', category: 'IT', color: '#ffaaa5', symbolSize: 75,
                content: {
                    tagColor: '#ffaaa5',
                    intro: 'å¯¹ä¸ªäººçº³ç¨å¹´åº¦å†…çš„å…¨çƒæ”¶å…¥å¾ç¨ã€‚é€»è¾‘å¿…é¡»çº¿æ€§ï¼šåŒºåˆ†æ”¶å…¥ç±»å‹ -> æ‰£é™¤å‡å… -> ç¡®è®¤ç¨ç‡ã€‚',
                    sections: [
                        {
                            title: '1. æ ¸å¿ƒæ¦‚å¿µä¸ç¨ç‡ (Basic Principles)',
                            content: `
                                <ul>
                                    [cite_start]<li><b>å¾ç¨é¡ºåº (Order):</b> 1. Non-Savings (NS) -> 2. Savings (Sav) -> 3. Dividends (Div)ã€‚[cite: 366, 367, 376]</li>
                                    [cite_start]<li><b>ä¸ªäººå…ç¨é¢ (PA):</b> <span class="rate-badge">Â£12,570</span>ã€‚ä½†å½“ ANI > Â£100k æ—¶ï¼Œæ¯Â£2æ”¶å…¥å‡å°‘Â£1 PAã€‚[cite: 391, 397]</li>
                                    <li><b>ç¨ç‡ (Rates):</b>
                                        <br>- Non-Savings: 20% / 40% / 45%
                                        [cite_start]<br>- Dividends: 8.75% / 33.75% / 39.35% [cite: 379]
                                    </li>
                                </ul>`
                        },
                        {
                            title: '2. é›‡ä½£ä¸ç¤¾ä¿ (Employment & NIC)',
                            content: `
                                <ul>
                                    [cite_start]<li><b>ç”¨è½¦ç¦åˆ© (Car Benefit):</b> List Price Ã— % (Base 55g=16%, Max 37%)ã€‚[cite: 17, 182]</li>
                                    <li><b>NIC (FA24 é‡ç‚¹):</b>
                                        [cite_start]<br>- Class 1 (Emp): Â£12,570-Â£50,270 @ <span class="highlight">8%</span> [cite: 82]
                                        [cite_start]<br>- Class 4 (Self): åŒåŒºé—´ @ <span class="highlight">6%</span> [cite: 82]
                                    </li>
                                </ul>`
                        },
                        {
                            title: '3. è®¡ç®—æ¨¡æ¿ (Proforma)',
                            content: `
                                Net Income = Total Income - Reliefs (Interest)<br>
                                Less: PA (adjusted for ANI)<br>
                                = Taxable Income<br>
                                <b>Extension:</b> Gift Aid & Pension ä¼šæ‰©å±• Basic & Higher Rate Bandsã€‚`
                        },
                        {
                            title: '4. ç»¼åˆå¤§é¢˜ (Master Question)',
                            isQuestion: true,
                            q: `<b>Scenario:</b> Alice (23/24)<br>â€¢ Salary: Â£110,000 (PAYE Â£25k)<br>â€¢ Dividends: Â£5,000<br>â€¢ Gift Aid Paid (Net): Â£4,000<br><br><b>Requirement:</b> è®¡ç®— Alice çš„åº”è¡¥ç¼´ç¨æ¬¾ (Income Tax Payable)ã€‚`,
                            a: `<b>Step 1: ANI Check (PA Reduction)</b>
Net Income = 110,000 + 5,000 = Â£115,000
Gross Gift Aid = 4,000 Ã— 100/80 = Â£5,000
ANI = 115,000 - 5,000 = Â£110,000

PA Reduction = (110,000 - 100,000) / 2 = Â£5,000
Available PA = 12,570 - 5,000 = <b>Â£7,570</b>

<b>Step 2: Band Extension</b>
Basic Band = 37,700 + 5,000 = <b>Â£42,700</b>
Higher Band starts at Â£42,701 up to (125,140 + 5,000) = Â£130,140

<b>Step 3: Computation</b>
Non-Savings (Salary): Â£110,000 - Â£7,570 = Â£102,430
- Basic: 42,700 @ 20% = 8,540
- Higher: (102,430 - 42,700) = 59,730 @ 40% = 23,892
(Total NS Tax = 32,432)

Dividends (Â£5,000):
- Nil Rate: Â£500 @ 0% = 0 (FA24 Limit)
- Higher: 4,500 @ 33.75% = 1,518.75

<b>Total Liability:</b> 32,432 + 1,518.75 = Â£33,950.75
Less PAYE: (25,000)
<b>Tax Payable: Â£8,950.75</b>`,
                            note: 'æ˜“é”™ç‚¹ï¼š1. è‚¡æ¯å…ç¨é¢ FA24 é™ä¸º Â£500ã€‚2. è®¡ç®— ANI æ—¶è¦å‡å» Gross Gift Aidã€‚3. ç¨ç‡å¸¦æ‰©å±•ç”¨çš„æ˜¯ Gross Gift Aidã€‚'
                        }
                    ]
                }
            },
            // ================= 2. Corporation Tax =================
            {
                id: 'ct', name: 'Corp Tax\nå…¬å¸ç¨', category: 'CT', color: '#a8d8ea', symbolSize: 75,
                content: {
                    tagColor: '#a8d8ea',
                    intro: 'å…¬å¸å¯¹å…¶ä¼šè®¡æœŸé—´å†…çš„åº”ç¨æ€»åˆ©æ¶¦ (TTP) ç¼´ç¨ã€‚',
                    sections: [
                        {
                            title: '1. æ ¸å¿ƒç¨ç‡ (Tax Rates)',
                            content: `
                                <ul>
                                    [cite_start]<li><b>Lower Limit (Â£50k):</b> <span class="rate-badge">19%</span> (Small Profits Rate) [cite: 48]</li>
                                    [cite_start]<li><b>Upper Limit (Â£250k):</b> <span class="rate-badge">25%</span> (Main Rate) [cite: 48]</li>
                                    <li><b>Marginal Relief:</b> å½“åˆ©æ¶¦åœ¨ä¸¤è€…ä¹‹é—´æ—¶é€‚ç”¨ã€‚
                                        [cite_start]<br>å…¬å¼: <span class="highlight">(U - A) Ã— 3/200</span> [cite: 49]
                                    </li>
                                    <li><b>Augmented Profits (AP):</b> TTP + Franked Investment Income (FGL - Dividends from non-group companies)ã€‚AP ç”¨æ¥ç¡®å®šç¨ç‡åŒºé—´ã€‚</li>
                                </ul>`
                        },
                        {
                            title: '2. èµ„æœ¬å‡å… (Capital Allowances)',
                            content: `
                                <ul>
                                    [cite_start]<li><b>Full Expensing (FA24):</b> å…¨æ–°ã€æœªä½¿ç”¨çš„ä¸»æ± èµ„äº§ (Main Pool) äº«å— <b>100% FYA</b>ã€‚æ— é‡‘é¢ä¸Šé™ã€‚[cite: 45]</li>
                                    [cite_start]<li><b>AIA:</b> Â£1,000,000ã€‚ç”¨äºäºŒæ‰‹èµ„äº§æˆ– SRP èµ„äº§ã€‚[cite: 45]</li>
                                    [cite_start]<li><b>SRP (Special Rate Pool):</b> å…¨æ–°èµ„äº§ 50% FYAï¼Œä½™é¢ 6% WDAã€‚[cite: 45]</li>
                                </ul>`
                        },
                        {
                            title: '3. äºæŸæŠµæ‰£ (Losses)',
                            content: `é¡ºåºï¼š1. [cite_start]Current Year (å…¨éƒ¨) -> 2. Carry Back (12ä¸ªæœˆï¼Œå…¨éƒ¨) -> 3. Carry Forward (æœªæ¥ï¼Œçµæ´»æŠµæ‰£ï¼Œå¯ä¿ç•™ QCD)ã€‚[cite: 916]`
                        },
                        {
                            title: '4. ç»¼åˆå¤§é¢˜ (Master Question)',
                            isQuestion: true,
                            q: `<b>Scenario:</b> C Ltd (æ— å…³è”å…¬å¸) ä¸šç»©ï¼š<br>â€¢ Trading Profit (adj): Â£190,000<br>â€¢ Bank Interest: Â£5,000<br>â€¢ Dividends Received (FGL): Â£20,000<br>â€¢ Bought New Machinery: Â£100,000 (Main Pool)<br><br><b>Requirement:</b> è®¡ç®— Corporation Taxã€‚`,
                            a: `<b>Step 1: TTP Calculation</b>
Adjusted Trading Profit: 190,000
Less: Capital Allowances (Full Expensing): (100,000)
Trading Income: 90,000
Add: Interest: 5,000
<b>TTP = Â£95,000</b>

<b>Step 2: Determine Rate (Augmented Profits)</b>
AP = TTP + Dividends
AP = 95,000 + 20,000 = <b>Â£115,000</b>
(Range: Â£50k - Â£250k -> Marginal Relief applies)

<b>Step 3: Tax Calculation</b>
Basic Tax: 95,000 (TTP) Ã— 25% = 23,750
Less Marginal Relief:
(250,000 - 115,000) Ã— 3/200 Ã— (95,000/115,000)
= 135,000 Ã— 0.015 Ã— 0.826...
= (1,672.83)

<b>Tax Liability = Â£22,077.17</b>`,
                            note: 'è‚¡æ¯ä¸äº¤ç¨ (Excluded from TTP)ï¼Œä½†å¿…é¡»åŠ å›ç®— AP ä»¥æŒ¤å‹ä½ç¨ç‡ç©ºé—´ã€‚Capital Allowances æ³¨æ„ Full Expensing ç›´æ¥ 100% æŠµæ‰£ã€‚'
                        }
                    ]
                }
            },
            // ================= 3. CGT =================
            {
                id: 'cgt', name: 'CGT\nèµ„æœ¬åˆ©å¾—', category: 'CGT', color: '#aa96da', symbolSize: 75,
                content: {
                    tagColor: '#aa96da',
                    intro: 'ä¸ªäººæˆ–å…¬å¸å¤„ç½®èµ„äº§çš„æ”¶ç›Šã€‚é‡ç‚¹åœ¨äº FA24 çš„ç¨ç‡å’Œå…ç¨é¢å˜åŒ–ã€‚',
                    sections: [
                        {
                            title: '1. æ ¸å¿ƒå‚æ•° (Individuals)',
                            content: `
                                <ul>
                                    [cite_start]<li><b>AEA (å…ç¨é¢):</b> <span class="highlight">Â£3,000</span> (FA24 å‡åŠ)ã€‚[cite: 74]</li>
                                    <li><b>ç¨ç‡ (Rates):</b>
                                        <br>- æ™®é€šèµ„äº§: 10% (Basic) / 20% (Higher)
                                        [cite_start]<br>- ä½å®…æˆ¿äº§: 18% (Basic) / <span class="highlight">24%</span> (Higher - FA24æ–°è§„)ã€‚[cite: 74]
                                    </li>
                                </ul>`
                        },
                        {
                            title: '2. å•†ä¸šèµ„äº§ä¼˜æƒ  (BADR)',
                            content: `
                                <ul>
                                    <li><b>å®šä¹‰:</b> Business Asset Disposal Relief (åŸä¼ä¸šå®¶å‡å…)ã€‚</li>
                                    [cite_start]<li><b>ç¨ç‡:</b> 10% (ç»ˆèº«é™é¢ Â£1m)ã€‚[cite: 78]</li>
                                    <li><b>æ¡ä»¶:</b> æŒæœ‰å¹¶ç»è¥ä¸šåŠ¡ 2 å¹´ä»¥ä¸Šï¼›è‚¡ä»½éœ€ 5% æŒè‚¡ + å‘˜å·¥èº«ä»½ã€‚</li>
                                </ul>`
                        },
                        {
                            title: '3. ç»¼åˆå¤§é¢˜ (Master Question)',
                            isQuestion: true,
                            q: `<b>Scenario:</b> é«˜ç¨ç‡çº³ç¨äººå‡ºå”®ä¸¤é¡¹èµ„äº§ï¼š<br>1. æŠ•èµ„æˆ¿äº§ (Residential): Gain Â£20,000<br>2. è‚¡ç¥¨ (Shares): Gain Â£5,000<br><br><b>Requirement:</b> è®¡ç®— 23/24 CGT (å‡è®¾æœªç”¨ AEA)ã€‚`,
                            a: `<b>Strategy:</b> æ€»æ˜¯æŠŠ AEA (Â£3,000) åˆ†é…ç»™ç¨ç‡æœ€é«˜çš„æ”¶ç›Šã€‚

<b>1. Residential Property (Â£20k):</b>
Less: AEA (Â£3,000) -> ä¼˜å…ˆæŠµæ‰£ 24% ç¨ç‡éƒ¨åˆ†
Taxable = Â£17,000
Tax = 17,000 Ã— <b>24%</b> = Â£4,080
(æ³¨: FA24 ä½å®…é«˜ç¨ç‡æ˜¯ 24%ï¼Œä¸å†æ˜¯ 28%)

<b>2. Shares (Â£5k):</b>
Taxable = Â£5,000
Tax = 5,000 Ã— 20% = Â£1,000

<b>Total CGT = Â£5,080</b>`,
                            note: 'ä¸€å®šè¦è®°ä½ä½å®…ç¨ç‡é™åˆ°äº† 24%ï¼AEA åªæœ‰ Â£3,000ï¼'
                        }
                    ]
                }
            },
            // ================= 4. IHT =================
            {
                id: 'iht', name: 'IHT\né—äº§ç¨', category: 'IHT', color: '#95e1d3', symbolSize: 75,
                content: {
                    tagColor: '#95e1d3',
                    intro: 'æŒ‰ç”Ÿå‰è½¬ç§» -> æ­»åè¿½åŠ  -> æ­»äº¡é—äº§çš„æ—¶é—´è½´è®°å¿†ã€‚',
                    sections: [
                        {
                            title: '1. æ ¸å¿ƒç¨ç‡ (Basic Principles)',
                            content: `
                                <ul>
                                    [cite_start]<li><b>NRB (é›¶ç¨ç‡å¸¦):</b> Â£325,000ã€‚[cite: 63]</li>
                                    [cite_start]<li><b>RNRB (å±…ä½é›¶ç¨ç‡å¸¦):</b> Â£175,000 (éœ€ç•™ç»™ç›´ç³»åä»£)ã€‚[cite: 63]</li>
                                    <li><b>ç¨ç‡:</b> æ­»äº¡æ—¶ 40% / ç”Ÿå‰ CLT 20%ã€‚</li>
                                </ul>`
                        },
                        {
                            title: '2. ç”Ÿå‰è½¬ç§» (Lifetime Transfers)',
                            content: `
                                <ul>
                                    [cite_start]<li><b>PET (ç»™ä¸ªäºº):</b> èµ ä¸æ—¶æ— ç¨ã€‚æ´»è¿‡ 7 å¹´å…ç¨ã€‚æ­»åœ¨ 7 å¹´å†…å˜ä¸º Chargeableã€‚[cite: 1401]</li>
                                    [cite_start]<li><b>CLT (ç»™ä¿¡æ‰˜):</b> ç«‹å³å¾æ”¶ 20% (è¶…å‡º NRB éƒ¨åˆ†)ã€‚æ­»åœ¨ 7 å¹´å†…é‡ç®—ã€‚[cite: 1401]</li>
                                    [cite_start]<li><b>è±å…:</b> æ¯å¹´ Â£3,000 (å¯ç»“è½¬1å¹´)ï¼Œå°é¢ Â£250ï¼Œå©šåº†ç¤¼ç‰©ç­‰ã€‚[cite: 1400]</li>
                                </ul>`
                        },
                        {
                            title: '3. è®¡ç®—æ¨¡æ¿ (Proforma)',
                            content: `Step 1: Lifetime Tax (CLT only)<br>Step 2: Death Tax on Lifetime Gifts (7å¹´å†…)<br>Step 3: Death Estate (æ€»èµ„äº§ - å€ºåŠ¡ - è±å…)`
                        },
                        {
                            title: '4. ç»¼åˆå¤§é¢˜ (Master Question)',
                            isQuestion: true,
                            q: `<b>Scenario:</b> John 2024å¹´å»ä¸–ã€‚Estate Â£900k (å«è‡ªä½æˆ¿ Â£400k)ã€‚<br>â€¢ ç”Ÿå‰ 2020å¹´ ç»™ä¿¡æ‰˜ (CLT) Â£200kã€‚<br>â€¢ æˆ¿å­ç•™ç»™å„¿å­ã€‚<br>â€¢ 2020å¹´ CLT æ—¶ NRB å®Œæ•´ã€‚<br><b>Requirement:</b> è®¡ç®—æ­»äº¡æ—¶çš„ IHTã€‚`,
                            a: `<b>Step 1: Check Lifetime Tax (Death Tax on CLT)</b>
Gift (2020): Â£200,000
Less AE (20/21 & 19/20): (6,000)
Value: Â£194,000 (Covered by NRB Â£325k, Tax = 0)
NRB Used = Â£194,000

<b>Step 2: Death Estate</b>
Total Estate: Â£900,000
Less Exemptions: 0
Chargeable Estate: Â£900,000

<b>Step 3: Calculate Tax</b>
Available NRB = 325,000 - 194,000 (Used by CLT) = Â£131,000
Available RNRB = Â£175,000 (ç•™ç»™å„¿å­ï¼Œé€‚ç”¨)
Total Tax Free = 131,000 + 175,000 = Â£306,000

Taxable = 900,000 - 306,000 = Â£594,000
<b>IHT = 594,000 Ã— 40% = Â£237,600</b>`,
                            note: 'ç”Ÿå‰ 7 å¹´å†…çš„ CLT ä¼šåå™¬æ­»äº¡æ—¶çš„ NRBã€‚åƒä¸‡åˆ«å¿˜äº†æŠŠ CLT ç”¨æ‰çš„é¢åº¦æ‰£é™¤ã€‚'
                        }
                    ]
                }
            },
            // ================= 5. VAT =================
            {
                id: 'vat', name: 'VAT\nå¢å€¼ç¨', category: 'VAT', color: '#ffeaa7', symbolSize: 75,
                content: {
                    tagColor: '#ffeaa7',
                    intro: 'æ³¨å†Œã€æ³¨é”€ä¸è®¡ç®—ã€‚æ³¨æ„ PPD æŠ˜æ‰£è§„åˆ™ã€‚',
                    sections: [
                        {
                            title: '1. æ³¨å†Œé—¨æ§› (FA24 Updated)',
                            content: `
                                <ul>
                                    [cite_start]<li><b>æ³¨å†Œ (Registration):</b> è¿‡å» 12 ä¸ªæœˆ > <span class="highlight">Â£90,000</span>ã€‚[cite: 67]</li>
                                    [cite_start]<li><b>æ³¨é”€ (Deregistration):</b> æœªæ¥ 12 ä¸ªæœˆ < <span class="highlight">Â£88,000</span>ã€‚[cite: 68]</li>
                                    <li><b>Flat Rate Scheme:</b> åŠ å…¥ <Â£150kï¼Œé€€å‡º >Â£230kã€‚</li>
                                </ul>`
                        },
                        {
                            title: '2. ç»¼åˆå¤§é¢˜ (Master Question)',
                            isQuestion: true,
                            q: `<b>Scenario:</b><br>1. é”€å”®å•†å“ Â£2,000 (Net)ï¼Œæä¾› 3% PPDã€‚å®¢æˆ·ä»˜æ¬¾äº†å¹¶äº«å—äº†æŠ˜æ‰£ã€‚<br>2. è´­ä¹°è½¦ç”¨äº 50% ç§ç”¨ï¼Œè½¦ä»· Â£24,000 (å« VAT)ã€‚<br><b>Requirement:</b> è®¡ç®— Output VAT å’Œå¯æŠµæ‰£çš„ Input VATã€‚`,
                            a: `<b>1. Output VAT (PPD Rule)</b>
VAT åŸºäºå®é™…æ”¶åˆ°é‡‘é¢ã€‚
Discounted Price = 2,000 Ã— 97% = Â£1,940
Output VAT = 1,940 Ã— 20% = <b>Â£388</b>

<b>2. Input VAT (Car Rule)</b>
è½¦å¦‚æœæœ‰ç§ç”¨ï¼ŒInput VAT <b>100% ä¸å¯æŠµæ‰£</b> (Blocked)ã€‚
Input VAT Claimable = <b>Â£0</b>

(æ³¨æ„ï¼šå¦‚æœæ˜¯ä¿®è½¦è´¹/æ²¹è´¹ï¼Œä¸”æœ‰ç§ç”¨ï¼Œé‚£æ˜¯å¯ä»¥éƒ¨åˆ†æŠµæ‰£æˆ–é€šè¿‡ Fuel Scale Charge å¤„ç†çš„ï¼Œä½†ä¹°è½¦æœ¬èº«ä¸è¡Œ)`,
                            note: 'PPD è§„åˆ™ï¼šæ”¶å¤šå°‘é’±ï¼Œäº¤å¤šå°‘ç¨ã€‚ä¹°è½¦è¿›é¡¹ç¨ï¼šåªè¦æœ‰ä¸€ç‚¹ç§ç”¨ï¼Œå…¨é¢ä¸å¯æŠµæ‰£ (é™¤éæ˜¯å‡ºç§Ÿè½¦æˆ–é©¾æ ¡è½¦)ã€‚'
                        }
                    ]
                }
            }
        ];

        // è¿çº¿å…³ç³» (ç¯ç»•å¸ƒå±€)
        const links = [
            { source: 'root', target: 'it' },
            { source: 'root', target: 'ct' },
            { source: 'root', target: 'cgt' },
            { source: 'root', target: 'iht' },
            { source: 'root', target: 'vat' }
        ];

        // ECharts é…ç½®
        const option = {
            backgroundColor: '#f7f5f0',
            tooltip: { show: false }, // ç¦ç”¨é»˜è®¤æç¤ºæ¡†ï¼Œä½¿ç”¨è‡ªå®šä¹‰å¼¹çª—
            series: [
                {
                    type: 'graph',
                    layout: 'force',
                    data: dataPoints,
                    links: links,
                    roam: true,
                    draggable: true,
                    zoom: 0.9,
                    label: {
                        show: true,
                        position: 'bottom',
                        formatter: '{b}',
                        color: '#636e72',
                        fontSize: 11,
                        fontWeight: 'bold'
                    },
                    itemStyle: {
                        borderColor: '#fff',
                        borderWidth: 3,
                        shadowBlur: 10,
                        shadowColor: 'rgba(0,0,0,0.1)'
                    },
                    lineStyle: {
                        color: '#bdc3c7',
                        width: 1.5,
                        curveness: 0.1
                    },
                    force: {
                        repulsion: 450,
                        edgeLength: 110,
                        gravity: 0.08
                    }
                }
            ]
        };

        myChart.setOption(option);
        window.addEventListener('resize', function() { myChart.resize(); });

        // ================= äº¤äº’é€»è¾‘ =================
        const mask = document.getElementById('mask');
        const sheet = document.getElementById('sheet');
        const sheetTitle = document.getElementById('sheetTitle');
        const sheetTag = document.getElementById('sheetTag');
        const sheetContent = document.getElementById('sheetContent');

        // ç‚¹å‡»äº‹ä»¶
        myChart.on('click', function(params) {
            if (params.data.content) {
                openSheet(params.data);
            }
        });

        function openSheet(node) {
            const content = node.content;
            
            // æ¸²æŸ“å¤´éƒ¨
            sheetTitle.innerText = node.name.replace('\n', ' ');
            sheetTag.innerText = node.category;
            sheetTag.style.backgroundColor = node.color;
            
            // æ¸²æŸ“å†…å®¹
            let html = `<div class="lecture-block">
                            <div class="text-content" style="font-size:15px; color:#2c3e50;">${content.intro}</div>
                        </div>`;

            content.sections.forEach(section => {
                html += `<div class="lecture-block">
                            <div class="lecture-title" style="border-color:${node.color}">${section.title}</div>`;
                
                if (section.isQuestion) {
                    // ç»¼åˆé¢˜æ¸²æŸ“
                    html += `<div class="exam-box">
                                <div class="exam-header">EXAM STANDARD QUESTION</div>
                                <div class="exam-body">
                                    ${section.q}
                                    <details>
                                        <summary>è§£æä¸æ¿ä¹¦</summary>
                                        <div class="solution-area">${section.a}</div>
                                        <div class="lecturer-note">ğŸ’¡ <b>Lecturer's Note:</b><br>${section.note}</div>
                                    </details>
                                </div>
                             </div>`;
                } else {
                    // æ™®é€šçŸ¥è¯†ç‚¹
                    html += `<div class="text-content">${section.content}</div>`;
                }
                
                html += `</div>`;
            });

            sheetContent.innerHTML = html;
            
            // æ˜¾ç¤ºå¼¹çª—
            mask.classList.add('show');
            sheet.classList.add('show');
        }

        function closeSheet() {
            mask.classList.remove('show');
            sheet.classList.remove('show');
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ACCA TX (UK) FA2024 Integrated Master Guide</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* === è«å…°è¿ªç»¼åˆä¸»é¢˜ (PC/Mobile é€‚é…) === */
        :root {
            /* é¢œè‰²å®šä¹‰ */
            --iht-main: #1abc9c;  /* è–„è·ç»¿ */
            --cgt-main: #a29bfe;  /* æš®å±±ç´« */
            --text: #2c3e50;
            --bg: #f4f7f6;
            --glass: rgba(255, 255, 255, 0.95);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; padding: 0; overflow: hidden; background-color: var(--bg); font-family: -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        #main { width: 100vw; height: 100vh; z-index: 1; }

        /* é¡¶éƒ¨æ  */
        .header {
            position: fixed; top: 0; left: 0; right: 0; height: 50px;
            background: rgba(255,255,255,0.85); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        .header h1 { font-size: 16px; color: #555; font-weight: 800; letter-spacing: 1px; margin: 0; }
        .badge { background: #2c3e50; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px; }

        /* è¯¦æƒ…é¢æ¿ (è‡ªé€‚åº”) */
        .sheet-mask {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.25); z-index: 199; display: none; transition: opacity 0.3s;
        }
        .sheet-mask.active { display: block; opacity: 1; }

        .sheet-container {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--glass); z-index: 200;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
            transform: translateY(110%); transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            display: flex; flex-direction: column;
            max-height: 85vh; /* æ‰‹æœºé»˜è®¤ */
            border-radius: 24px 24px 0 0;
        }
        /* ç”µè„‘ç«¯ä¼˜åŒ– */
        @media (min-width: 768px) {
            .sheet-container { max-height: 75vh; border-top: 1px solid #eee; }
        }
        .sheet-container.active { transform: translateY(0); }

        /* é¢æ¿å¤´éƒ¨ */
        .sheet-head {
            padding: 18px 24px; border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
            background: #fff; border-radius: 24px 24px 0 0;
        }
        .sheet-title { font-size: 18px; font-weight: 800; color: var(--text); margin: 0; display:flex; align-items:center;}
        .sheet-title::before { content:''; display:inline-block; width:6px; height:6px; border-radius:50%; margin-right:10px; background: #ccc; } /* JSä¼šä¿®æ”¹é¢œè‰² */
        .close-btn { font-size: 24px; color: #b2bec3; cursor: pointer; }

        /* å†…å®¹åŒº */
        .sheet-body { padding: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; flex: 1; }
        .content-container { max-width: 800px; margin: 0 auto; padding: 24px; }

        /* --- æ’ç‰ˆç»„ä»¶ --- */
        /* 1. å®šä¹‰å— */
        .def-box { margin-bottom: 25px; border-left: 4px solid #ccc; padding-left: 12px; } /* JSä¿®æ”¹è¾¹æ¡†è‰² */
        .def-title { font-size: 12px; font-weight: 800; color: #999; margin-bottom: 6px; text-transform: uppercase; }
        .def-text { font-size: 15px; line-height: 1.7; color: #555; text-align: justify; }

        /* 2. è§„åˆ™åˆ—è¡¨ */
        .rule-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-bottom: 25px; }
        .rule-card {
            background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.015);
        }
        .rule-head { font-size: 12px; font-weight: 800; margin-bottom: 6px; color: #555; }
        .rule-body { font-size: 14px; color: #333; line-height: 1.5; }

        /* 3. æ¡ˆä¾‹/æ¨¡æ¿ */
        .case-box {
            background: #fcfcfc; border: 1px solid #f0f0f0; border-radius: 8px;
            padding: 15px; margin-top: 15px;
        }
        .case-head { font-weight: 700; color: #2c3e50; margin-bottom: 8px; font-size: 14px; }
        .case-body { font-size: 14px; color: #444; white-space: pre-wrap; font-family: -apple-system, sans-serif; line-height: 1.6; }

        /* 4. æŠ˜å è§£æ */
        details { margin-top: 10px; border-top: 1px dashed #eee; padding-top: 10px; }
        summary {
            cursor: pointer; font-size: 13px; color: #7f8c8d; font-weight: 600;
            list-style: none; display: flex; justify-content: space-between;
        }
        summary::after { content: 'æŸ¥çœ‹è§£æ â–¼'; color: #aaa; }
        details[open] summary::after { content: 'æ”¶èµ· â–²'; }
        
        .analysis {
            background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 10px;
            font-family: "Menlo", monospace; font-size: 13px; color: #2c3e50; line-height: 1.6; white-space: pre-wrap; border: 1px solid #eee;
        }

        /* BOSS é¢˜ */
        .boss-card {
            background: #fff; border: 2px solid #e67e22; border-radius: 12px;
            overflow: hidden; margin-top: 20px;
        }
        .boss-header {
            background: #e67e22; color: #fff; padding: 10px 15px;
            font-size: 14px; font-weight: 800; letter-spacing: 1px;
        }
        .boss-body { padding: 15px; font-size: 14px; color: #333; line-height: 1.6; }

        /* è¡¨æ ¼ */
        .tax-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        .tax-table th { background: #f1f2f6; color: #333; padding: 8px; text-align: left; border:1px solid #ddd; }
        .tax-table td { border: 1px solid #ddd; padding: 8px; }

        .hl-red { color: #c0392b; font-weight: bold; }

    </style>
</head>
<body>

    <div class="header">
        <h1>ACCA TX (UK) <span class="badge">FA2024</span></h1>
    </div>

    <div id="main"></div>

    <div class="sheet-mask" id="mask" onclick="closeSheet()"></div>
    <div class="sheet-container" id="sheet">
        <div class="sheet-head">
            <h2 class="sheet-title" id="sheetTitle">Topic</h2>
            <div class="close-btn" onclick="closeSheet()">Ã—</div>
        </div>
        <div class="sheet-body">
            <div class="content-container" id="sheetContent"></div>
        </div>
    </div>

    <script type="text/javascript">
        var chartDom = document.getElementById('main');
        var myChart = echarts.init(chartDom, null, {renderer: 'canvas'});

        // ================= 1. é…è‰²å®šä¹‰ =================
        const c = {
            root: '#34495e',   // æ€»æ ¹ (æ·±ç°)
            iht: '#1abc9c',    // IHT (è–„è·ç»¿)
            iht_sub: '#a8e6cf',
            cgt: '#a29bfe',    // CGT (æš®å±±ç´«)
            cgt_sub: '#dcd6f7',
            boss: '#e67e22'    // BOSSé¢˜ (æ©™è‰²)
        };

        // ================= 2. èŠ‚ç‚¹æ•°æ® (Merged IHT + CGT) =================
        const data = [
            // --- Grand Root ---
            {
                id: '0', name: 'ACCA TX\n(UK)', category: 'ROOT', symbolSize: 60,
                itemStyle: { color: c.root, shadowBlur: 15, shadowColor: 'rgba(0,0,0,0.2)' },
                info: { def: 'FA2024 æ ¸å¿ƒå¤ä¹ å›¾è°± (June 25 - Mar 26)', rules: [{t:'åŒ…å«æ¨¡å—', c:'IHT (é—äº§ç¨) + CGT (èµ„æœ¬åˆ©å¾—ç¨)'}] }
            },

            // =================== IHT æ¨¡å— (è–„è·ç»¿) ===================
            {
                id: 'iht_root', name: 'IHT\né—äº§ç¨', category: 'IHT', symbolSize: 50,
                itemStyle: { color: c.iht },
                info: {
                    def: 'åŸºäºä»·å€¼è½¬ç§» (Transfer of Value)ã€‚',
                    rules: [
                        {t: 'NRB', c: 'Â£325,000'}, {t: 'RNRB', c: 'Â£175,000'},
                        {t: 'Death Rate', c: '40%'}, {t: 'Lifetime', c: '20% (Trustee) / 25% (Donor)'}
                    ]
                }
            },
            {
                id: 'iht_life', name: 'Lifetime\nç”Ÿå‰è½¬ç§»', category: 'IHT_SUB', symbolSize: 35, itemStyle: { color: c.iht_sub },
                info: {
                    def: 'è±å… / PET / CLT',
                    rules: [
                        {t: 'Exempt', c: 'Spouse (æ— é™), AE (Â£3k/yr), Marriage (Â£5k/2.5k/1k), Small Gifts (Â£250).'},
                        {t: 'PET', c: 'ä¸ªäººå¯¹ä¸ªäººã€‚ç”Ÿå‰0ç¨ã€‚æ´»è¿‡7å¹´å…ç¨ã€‚'},
                        {t: 'CLT', c: 'ä¸ªäººå¯¹ä¿¡æ‰˜ã€‚ç«‹å³äº¤ç¨ (20%)ã€‚7å¹´ç´¯ç§¯åŸåˆ™ã€‚'}
                    ],
                    cases: [{t: 'æ¡ˆä¾‹: ç²¾æ‰“ç»†ç®—çš„çˆ·çˆ·', s: '2024å¹´é€å­™å­ç»“å©šç¤¼ç‰© Â£8,000ã€‚ä¸Šå¹´æœªèµ äºˆã€‚', a: 'Transfer: Â£8,000\n(-) Marriage: (Â£2,500)\n(-) AE Cur: (Â£3,000)\n(-) AE BF: (Â£2,500)\n= Chargeable: Â£0'}]
                }
            },
            {
                id: 'iht_death', name: 'Death Tax\næ­»åè¿½æº¯', category: 'IHT_SUB', symbolSize: 35, itemStyle: { color: c.iht_sub },
                info: {
                    def: 'æ­»å‰7å¹´å†…çš„ PET/CLT é‡ç®—ã€‚',
                    rules: [
                        {t: 'æ­¥éª¤', c: '1. æ‰¾7å¹´å†…ç¤¼ç‰© 2. æ‰£NRB (Look back 7 yrs from GIFT) 3. ç®—40%ç¨ 4. Taper Relief'},
                        {t: 'Taper', c: '3-4yr: 80% of tax ... 6-7yr: 20% of tax'}
                    ],
                    cases: [{t: 'æ¡ˆä¾‹: ä¸å¹¸çš„å¯Œè±ª', s: 'é€å‡º Â£100k PET å 4.5 å¹´å»ä¸–ã€‚', a: 'Gross: Â£100,000\nNRB Available: Â£325,000\nTax: Â£0 (Covered)\n(ä½†åƒæ‰äº† Â£100k NRB)'}]
                }
            },
            {
                id: 'iht_estate', name: 'Estate\næ­»äº¡é—äº§', category: 'IHT_SUB', symbolSize: 35, itemStyle: { color: c.iht_sub },
                info: {
                    def: 'æ­»äº¡æ—¶èµ„äº§æ€»å€¼ (Probate Value)ã€‚',
                    rules: [{t: 'RNRB Â£175k', c: 'æ¡ä»¶: ä¸»å±…æ‰€ + ç›´ç³»åä»£ã€‚'}, {t: 'Spouse', c: 'é…å¶ç»§æ‰¿å…ç¨ã€‚'}],
                    cases: [{t: 'æ¡ˆä¾‹: æœ€åçš„é—äº§', s: 'ç•™ç»™å­™å­æˆ¿Â£400k + å…¶ä»–Â£200kã€‚', a: 'Estate: Â£600,000\n(-) RNRB: (Â£175,000)\n(-) NRB: (Â£325,000)\nTaxable: Â£100,000\nTax @ 40% = Â£40,000'}]
                }
            },
            {
                id: 'iht_boss', name: 'IHT BOSS\nç»¼åˆå¤§é¢˜', category: 'BOSS', symbolSize: 45, itemStyle: { color: c.boss },
                info: {
                    isBoss: true, title: 'ğŸ‘¹ IHT ç»ˆææˆ˜ï¼šNRB è€—å°½',
                    scen: 'Mr. Bond (2026å¹´3æœˆå»ä¸–)ã€‚\n1. 2019.8 CLT Â£280k\n2. 2021.10 PET Â£150k\n3. Estate: æˆ¿Â£500k(ç»™å„¿), è‚¡Â£300k, å€ºÂ£25kã€‚',
                    ans: `<b>Step 1: ç”Ÿå‰å ç”¨æ£€æŸ¥</b>
1. CLT (Â£280k): å ç”¨ Â£280k NRBã€‚
   å‰©ä½™ NRB = 45kã€‚
2. PET (Â£150k): å˜æˆ Chargeableã€‚
   åƒæ‰å‰©ä½™ 45k NRB å¹¶æº¢å‡ºã€‚
   <b>ç»“è®ºï¼šæ­»äº¡æ—¶ NRB = 0ã€‚</b>

<b>Step 2: é—äº§ç¨è®¡ç®—</b>
Net Estate: Â£775,000 (Â£800k - Â£25k)
Less RNRB: (Â£175,000)
Less NRB: (Â£0)
Taxable: Â£600,000
<b>Tax @ 40% = Â£240,000</b>`
                }
            },

            // =================== CGT æ¨¡å— (æš®å±±ç´«) ===================
            {
                id: 'cgt_root', name: 'CGT\nèµ„æœ¬åˆ©å¾—', category: 'CGT', symbolSize: 50,
                itemStyle: { color: c.cgt },
                info: {
                    def: 'å¤„ç½®èµ„äº§åˆ©å¾—ç¨ (Capital Gains Tax)ã€‚',
                    rules: [
                        {t: 'AEA', c: '<b>Â£3,000</b> (FA24)'},
                        {t: 'Normal Rates', c: '10% / 20%'},
                        {t: 'Residential', c: '18% / <span class="hl-red">24%</span> (FA24 æ–°ç¨ç‡)'},
                        {t: 'BADR', c: '10% (Limit Â£1m)'}
                    ]
                }
            },
            {
                id: 'cgt_comp', name: 'Compute\nè®¡ç®—è§„åˆ™', category: 'CGT_SUB', symbolSize: 35, itemStyle: { color: c.cgt_sub },
                info: {
                    def: 'è®¡ç®—æ¡†æ¶ä¸ Loss æŠµæ‰£ã€‚',
                    rules: [{t: 'Losses', c: 'CY Loss å¿…é¡»å…¨æŠµ; BF Loss åªæŠµåˆ° AEA ä¸ºæ­¢ã€‚'}],
                    proformas: [{t: 'Proforma', c: 'Proceeds - Cost - Enhancement = Gain'}],
                    cases: [{t: 'æ¡ˆä¾‹: æˆ¿äº§ vs è‚¡ç¥¨', s: 'å–æˆ¿èµšÂ£20k (High Rate)ï¼Œå–è‚¡èµšÂ£10kã€‚', a: 'AEA ä¼˜å…ˆæŠµæ‰£æˆ¿äº§ (24% > 20%)ã€‚\nResi Taxable: 20k-3k=17k @ 24% = Â£4,080\nShare Taxable: 10k @ 20% = Â£2,000'}]
                }
            },
            {
                id: 'cgt_asset', name: 'Assets\nç‰¹æ®Šèµ„äº§', category: 'CGT_SUB', symbolSize: 35, itemStyle: { color: c.cgt_sub },
                info: {
                    def: 'Chattels (åŠ¨äº§) & Shares (è‚¡ç¥¨)ã€‚',
                    rules: [
                        {t: 'Chattels', c: 'Â£6k è§„åˆ™ã€‚Wasting (<50yr) è±å…ã€‚Non-wasting ä¹°å–<6k è±å…ã€‚Marginal Relief: 5/3 x (Proceeds - 6k)ã€‚'},
                        {t: 'Shares', c: 'åŒ¹é…é¡ºåº: 1. Same Day 2. Next 30 Days 3. Share Pool (å‡ä»·)ã€‚'}
                    ]
                }
            },
            {
                id: 'cgt_relief', name: 'Reliefs\næ ¸å¿ƒå‡å…', category: 'CGT_SUB', symbolSize: 35, itemStyle: { color: c.cgt_sub },
                info: {
                    def: 'BADR, ROR, Gift, PPRã€‚',
                    rules: [
                        {t: 'BADR', c: 'ç¨ç‡ 10%ã€‚æ¡ä»¶: ç»è¥2å¹´ã€‚'},
                        {t: 'Rollover (ROR)', c: 'å–æ—§ä¹°æ–°ï¼ŒGain æ¨è¿Ÿã€‚çª—å£: -1yr ~ +3yrã€‚'},
                        {t: 'PPR', c: 'è‡ªä½æˆ¿è±å…ã€‚æœ€å9ä¸ªæœˆè§†åŒå±…ä½ã€‚'}
                    ]
                }
            },
            {
                id: 'cgt_boss', name: 'CGT BOSS\nç»¼åˆå¤§é¢˜', category: 'BOSS', symbolSize: 45, itemStyle: { color: c.boss },
                info: {
                    isBoss: true, title: 'ğŸ‘¹ CGT ç»ˆææˆ˜ï¼šMr. Lucky',
                    scen: 'Mr. Lucky (High Rate) 2025/26:\n1. å–èŠ±ç“¶: å–Â£8k, ä¹°Â£4kã€‚\n2. å–å’–å•¡åº—: èµšÂ£200k (BADR)ã€‚\n3. å–è‚¡ç¥¨: 1000è‚¡@Â£5 (Pool Cost Â£2.67)ã€‚\n4. BF Loss Â£500ã€‚',
                    ans: `<b>Step 1: Chattel (Vase)</b>
Marginal Relief: 5/3 Ã— (8000 - 6000) = Â£3,333.
(Normal Gain Â£4k, å–å°å€¼) -> <b>Â£3,333</b>

<b>Step 2: Business (BADR)</b>
Â£200,000 @ 10% = <b>Â£20,000</b>

<b>Step 3: Shares</b>
Gain = 1000 Ã— (5 - 2.67) = <b>Â£2,333</b>

<b>Step 4: Total Tax</b>
Total Gains = 205,666
(-) Loss Â£500 (-) AEA Â£3,000
Taxable = Â£202,166
(BADR 200k @ 10%; Remainder 2,166 @ 20%)
<b>Total Tax = Â£20,433</b>`
                }
            }
        ];

        // ================= 3. è¿çº¿å…³ç³» =================
        const links = [
            // Root -> Main
            { source: '0', target: 'iht_root' },
            { source: '0', target: 'cgt_root' },
            // IHT Internal
            { source: 'iht_root', target: 'iht_life' },
            { source: 'iht_life', target: 'iht_death' },
            { source: 'iht_death', target: 'iht_estate' },
            { source: 'iht_estate', target: 'iht_boss' },
            // CGT Internal
            { source: 'cgt_root', target: 'cgt_comp' },
            { source: 'cgt_comp', target: 'cgt_asset' },
            { source: 'cgt_root', target: 'cgt_relief' },
            { source: 'cgt_relief', target: 'cgt_boss' }
        ];

        // ================= 4. æ¸²æŸ“é…ç½® =================
        const option = {
            backgroundColor: 'transparent',
            series: [{
                type: 'graph',
                layout: 'force',
                data: data,
                links: links,
                roam: true,
                zoom: 0.8,
                label: { show: true, position: 'bottom', color: '#666', fontSize: 11, fontWeight: 'bold', formatter: '{b}' },
                itemStyle: { borderColor: '#fff', borderWidth: 2 },
                lineStyle: { color: '#d1d8e0', curveness: 0.15, width: 1.5 },
                force: { repulsion: 450, edgeLength: 90, gravity: 0.05 }
            }]
        };

        myChart.setOption(option);
        window.addEventListener('resize', () => myChart.resize());

        // ================= 5. äº¤äº’é€»è¾‘ =================
        const mask = document.getElementById('mask');
        const sheet = document.getElementById('sheet');
        const titleDom = document.getElementById('sheetTitle');
        const contentDom = document.getElementById('sheetContent');

        myChart.on('click', function(params) {
            if (params.data && params.data.info) openSheet(params.data);
        });

        function openSheet(node) {
            const info = node.info;
            const color = node.itemStyle.color;
            
            // è®¾ç½®æ ‡é¢˜é¢œè‰²
            titleDom.innerText = node.name.replace('\n', ' ');
            titleDom.style.color = color;
            document.querySelector('.sheet-title::before').style.background = color;
            document.querySelector('.def-box').style.borderLeftColor = color;

            let html = '';

            if (info.isBoss) {
                html += `<div class="boss-card">
                            <div class="boss-header">ğŸ”¥ ${info.title}</div>
                            <div class="boss-body" style="white-space:pre-wrap">${info.scen}</div>
                         </div>
                         <details open><summary>è§£æè¿‡ç¨‹</summary><div class="analysis">${info.ans}</div></details>`;
            } else {
                if(info.def) html += `<div class="def-box"><div class="def-title" style="color:${color}">Core Definition</div><div class="def-text">${info.def}</div></div>`;
                
                if(info.rules) {
                    html += `<div class="rule-grid">`;
                    info.rules.forEach(r => {
                        html += `<div class="rule-card"><div class="rule-head" style="color:${color}">${r.t}</div><div class="rule-body">${r.c}</div></div>`;
                    });
                    html += `</div>`;
                }

                if(info.cases) {
                    info.cases.forEach(c => {
                        html += `<div class="case-box" style="border-left-color:${color}"><div class="case-head" style="color:${color}">ğŸŒ° ${c.t}</div><div class="case-body">${c.s}</div><details><summary>è§£æ</summary><div class="analysis">${c.a}</div></details></div>`;
                    });
                }
                
                if(info.proformas) {
                    info.proformas.forEach(p => {
                         html += `<div class="rule-card" style="background:#f9f9f9; border-color:#eee"><div class="rule-head" style="color:#2c3e50">ğŸ“ ${p.t}</div><div class="rule-body" style="font-family:monospace; white-space:pre-wrap">${p.c}</div></div>`;
                    });
                }
            }

            contentDom.innerHTML = html;
            mask.classList.add('active');
            sheet.classList.add('active');
        }

        function closeSheet() {
            mask.classList.remove('active');
            sheet.classList.remove('active');
        }
    </script>
</body>
</html>

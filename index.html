<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ACCA TX (UK) FA2024 ç»ˆæä¿®å¤ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        /* === å…¨å±€é‡ç½® === */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; padding: 0; overflow: hidden; background-color: #f7f9fc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; }
        #main { width: 100vw; height: 100vh; z-index: 1; }

        /* === é¡¶éƒ¨å¯¼èˆªæ  (ç£¨ç ‚ç»ç’ƒ) === */
        .header {
            position: fixed; top: 0; left: 0; right: 0; height: 50px;
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 100;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        .header-title { font-size: 16px; font-weight: 800; color: #2c3e50; letter-spacing: -0.5px; }
        .header-tag { background: #2c3e50; color: #fff; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }

        /* === åº•éƒ¨è¯¦æƒ…å¡ç‰‡ (æ ¸å¿ƒä¿®å¤) === */
        .sheet-mask {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3); z-index: 199; display: none;
            opacity: 0; transition: opacity 0.3s;
        }
        .sheet-mask.active { display: block; opacity: 1; }

        .sheet-container {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #fff; z-index: 200;
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            transform: translateY(110%); transition: transform 0.35s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column; max-height: 85vh;
        }
        .sheet-container.active { transform: translateY(0); }

        /* å¡ç‰‡å¤´éƒ¨ */
        .sheet-header {
            padding: 20px 24px; border-bottom: 1px solid #f0f2f5;
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0; background: #fff; border-radius: 24px 24px 0 0;
        }
        .sheet-title-group { display: flex; flex-direction: column; }
        .sheet-category { font-size: 10px; font-weight: 800; color: #bdc3c7; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .sheet-title { font-size: 20px; font-weight: 800; color: #2c3e50; margin: 0; }
        .close-btn {
            width: 36px; height: 36px; background: #f1f2f6; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: #7f8c8d; cursor: pointer;
        }

        /* å¡ç‰‡å†…å®¹åŒº */
        .sheet-body { padding: 24px; overflow-y: auto; -webkit-overflow-scrolling: touch; background: #fff; }

        /* --- å†…å®¹æ’ç‰ˆç»„ä»¶ --- */
        /* 1. å®šä¹‰å— */
        .def-box { margin-bottom: 24px; }
        .def-title { font-size: 13px; font-weight: 700; color: #34495e; margin-bottom: 8px; display: flex; align-items: center; }
        .def-title::before { content:''; width:4px; height:14px; background:#3498db; margin-right:8px; border-radius:2px; }
        .def-text { font-size: 15px; line-height: 1.6; color: #57606f; }

        /* 2. è§„åˆ™èƒ¶å›Š */
        .rule-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 24px; }
        .rule-item { background: #f8fbff; border: 1px solid #e1eefc; padding: 12px; border-radius: 8px; font-size: 13px; color: #2c3e50; }
        .rule-label { font-weight: 800; color: #0984e3; display: block; margin-bottom: 4px; font-size: 11px; }

        /* 3. ç»¼åˆé¢˜å¡ç‰‡ */
        .exam-card {
            border: 1px solid #eaeaea; border-radius: 12px; overflow: hidden; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-top: 10px;
        }
        .exam-head {
            background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
            padding: 12px 16px; border-bottom: 1px solid #fceceb;
            font-size: 13px; font-weight: 700; color: #e17055; display: flex; align-items: center;
        }
        .exam-head::before { content: 'ğŸ”¥'; margin-right: 6px; }
        .exam-body { padding: 16px; font-size: 14px; line-height: 1.7; color: #2d3436; }

        /* 4. æŠ˜å è§£æ (é‡ç‚¹ä¼˜åŒ–ç‚¹å‡»åŒºåŸŸ) */
        details { margin-top: 15px; }
        summary {
            padding: 12px; background: #f7f9fc; border-radius: 8px; cursor: pointer;
            font-size: 13px; font-weight: 600; color: #2c3e50; list-style: none;
            display: flex; justify-content: space-between; align-items: center;
            transition: background 0.2s;
        }
        summary:active { background: #eef2f7; }
        summary::after { content: 'æŸ¥çœ‹è§£æ'; font-size: 11px; color: #95a5a6; }
        details[open] summary { background: #edf2f7; color: #0984e3; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        details[open] summary::after { content: 'æ”¶èµ·'; color: #0984e3; }

        /* 5. æ¿ä¹¦æ ·å¼ */
        .board-box {
            background: #fff; border: 1px solid #e1e8ed; border-top: none;
            padding: 16px; border-radius: 0 0 8px 8px;
            font-family: "Menlo", "Courier New", monospace; font-size: 13px; color: #34495e; line-height: 1.6;
        }
        .marker-tip {
            margin-top: 12px; background: #fffcf0; border: 1px solid #fcefd0;
            padding: 10px; border-radius: 6px; color: #d35400; font-size: 12px; font-weight: 600;
        }

        /* é«˜äº®æ ‡è®° */
        .hl-red { color: #e74c3c; font-weight: 800; }
        .hl-bg { background: #e8f6f3; padding: 0 4px; border-radius: 3px; color: #16a085; font-weight: bold; }

    </style>
</head>
<body>

    <div class="header">
        <div class="header-title">ACCA TX (UK) çŸ¥è¯†å›¾è°±</div>
        <div class="header-tag">FA2024</div>
    </div>

    <div id="main"></div>

    <div class="sheet-mask" id="mask" onclick="closeSheet()"></div>

    <div class="sheet-container" id="sheet">
        <div class="sheet-header">
            <div class="sheet-title-group">
                <span class="sheet-category" id="nodeCategory">CATEGORY</span>
                <h2 class="sheet-title" id="nodeTitle">Node Title</h2>
            </div>
            <div class="close-btn" onclick="closeSheet()">Ã—</div>
        </div>
        <div class="sheet-body" id="nodeContent">
            </div>
    </div>

    <script type="text/javascript">
        // ä¿®å¤ç§»åŠ¨ç«¯ç‚¹å‡»å»¶è¿Ÿ
        document.addEventListener('touchstart', function() {}, {passive: true});

        var chartDom = document.getElementById('main');
        var myChart = echarts.init(chartDom, null, {renderer: 'canvas'}); // å¼ºåˆ¶ Canvas æ¸²æŸ“

        // ================= é…è‰²æ–¹æ¡ˆ (ä¸“ä¸šçº§) =================
        const palette = {
            root: '#2c3e50', // æ·±è“ç°
            it: '#e74c3c',   // æ´»åŠ›çº¢ (Income Tax)
            ct: '#3498db',   // ç§‘æŠ€è“ (Corp Tax)
            cgt: '#9b59b6',  // é«˜çº§ç´« (CGT)
            iht: '#1abc9c',  // é’ç“·ç»¿ (IHT)
            vat: '#f39c12'   // ç¥ç€é»„ (VAT)
        };

        // ================= æ·±åº¦å†…å®¹åº“ (FA2024 Verified) =================
        const data = [
            {
                id: '0', name: 'UK TAX\nSystem', category: 'Overview', color: palette.root, size: 60,
                info: {
                    def: 'è‹±å›½äº”å¤§æ ¸å¿ƒç¨ç§ä½“ç³»ã€‚',
                    rules: [
                        {label: 'é€‚ç”¨è€ƒå­£', text: 'June 2025 - March 2026 (FA 2024)'},
                        {label: 'æ ¸å¿ƒå˜åŠ¨', text: 'NIC è´¹ç‡ä¸‹è°ƒ | CGT å…ç¨é¢å‡åŠ | VAT é—¨æ§›ä¸Šè°ƒ'}
                    ]
                }
            },
            // --- 1. Income Tax ---
            {
                id: '1', name: 'Income Tax\nä¸ªç¨ç»¼åˆ', category: 'IT', color: palette.it, size: 45,
                info: {
                    def: 'å¯¹ä¸ªäººå…¨çƒæ”¶å…¥çš„å¾ç¨ã€‚è§£é¢˜æ ¸å¿ƒæ˜¯ Proforma çš„é¡ºåºã€‚',
                    rules: [
                        {label: 'é¡ºåº', text: '1.Non-Savings -> 2.Savings -> 3.Dividends'},
                        {label: 'PA', text: 'Â£12,570 (ANI > Â£100k æ—¶é€’å‡)'},
                        {label: 'Band', text: 'Basic Â£37,700 | Higher Â£125,140'}
                    ],
                    q_scenario: 'Alice (23/24) å¹´è–ª Â£110,000ï¼Œè‚¡æ¯ Â£5,000ï¼Œæ”¯ä»˜ Gift Aid (Net) Â£4,000ã€‚',
                    q_task: 'è®¡ç®—åº”äº¤ç¨æ¬¾ã€‚',
                    q_answer: `1. <b>ANI Calculation (PA Check):</b>
Net Income = 110k + 5k = Â£115,000
Gross Gift Aid = 4,000 Ã— 100/80 = Â£5,000
ANI = 115,000 - 5,000 = <b>Â£110,000</b>

PA Reduction = (110,000 - 100,000) / 2 = Â£5,000
Available PA = 12,570 - 5,000 = <b>Â£7,570</b>

2. <b>Extend Band:</b>
Basic Band = 37,700 + 5,000 = <b>Â£42,700</b>

3. <b>Tax:</b>
Non-Savings (Â£110k - Â£7,570 = Â£102,430):
42,700 @ 20% = 8,540
59,730 @ 40% = 23,892
Dividends (Â£5k):
Â£500 @ 0% = 0 (FA24 Nil Rate)
Â£4,500 @ 33.75% = 1,518.75

<b>Total = Â£33,950.75</b>`,
                    note: 'Trap: è®¡ç®— ANI æ—¶è¦å‡å» Gross Gift Aidï¼Œä½†è®¡ç®—ç¨ç‡åŒºé—´æ—¶è¦åŠ ä¸Š Gross Gift Aid æ‰©å……åŒºé—´ã€‚'
                }
            },
            {
                id: '1.1', name: 'NIC\nç¤¾ä¿æ–°è§„', category: 'IT', color: palette.it, size: 35,
                info: {
                    def: 'FA2024 è´¹ç‡å¤§é™ï¼Œè€ƒè¯•é€åˆ†ç‚¹ã€‚',
                    rules: [
                        {label: 'Class 1 (Emp)', text: 'Â£12,570-Â£50,270: <span class="hl-red">8%</span> (åŸ10%)'},
                        {label: 'Class 4 (Self)', text: 'åŒåŒºé—´: <span class="hl-red">6%</span> (åŸ9%)'}
                    ],
                    q_scenario: 'è‡ªé›‡è€…åˆ©æ¶¦ Â£60,000ã€‚',
                    q_task: 'è®¡ç®— Class 4 NICã€‚',
                    q_answer: `Band 1 (Â£12,570 - Â£50,270):
(50,270 - 12,570) Ã— <b>6%</b> = Â£2,262

Band 2 (Â£50,270+):
(60,000 - 50,270) Ã— 2% = Â£194.6

<b>Total = Â£2,456.60</b>`,
                    note: 'åƒä¸‡åˆ«ç”¨æ—§ç¨ç‡ï¼'
                }
            },
            // --- 2. Corporation Tax ---
            {
                id: '2', name: 'Corp Tax\nå…¬å¸ç¨', category: 'CT', color: palette.ct, size: 45,
                info: {
                    def: 'Taxable Total Profits (TTP) è®¡ç®—ã€‚',
                    rules: [
                        {label: 'Rates', text: '19% (Small) | 25% (Main)'},
                        {label: 'Limits', text: 'Â£50,000 - Â£250,000 (æŒ‰å…³è”å…¬å¸æ•°å¹³åˆ†)'},
                        {label: 'Marginal Relief', text: '(U - A) Ã— 3/200'}
                    ],
                    q_scenario: 'å…¬å¸ Trading Profit Â£190k, Dividends Received (FGL) Â£10kã€‚æ— å…³è”å…¬å¸ã€‚',
                    q_task: 'è®¡ç®— CTã€‚',
                    q_answer: `1. <b>TTP</b> = Â£190,000 (ä¸å«è‚¡æ¯)
2. <b>Augmented Profits (AP)</b> = 190k + 10k = <b>Â£200,000</b>
(AP åœ¨ 50k-250k ä¹‹é—´ï¼Œé€‚ç”¨è¾¹é™…å‡å…)

3. <b>Tax:</b>
190,000 Ã— 25% = 47,500
Less Relief: (250k - 200k) Ã— 3/200 Ã— (190/200)
= 50,000 Ã— 0.015 Ã— 0.95 = (712.5)

<b>Payable = Â£46,787.5</b>`,
                    note: 'Augmented Profits ç”¨æ¥å®šç¨ç‡ï¼ŒTTP ç”¨æ¥ä¹˜ç¨ç‡ã€‚'
                }
            },
            {
                id: '2.1', name: 'Capital Allowances\nèµ„æœ¬å‡å…', category: 'CT', color: palette.ct, size: 35,
                info: {
                    def: 'FA24 å¼•å…¥ Full Expensing (å…¨é¢è´¹ç”¨åŒ–)ã€‚',
                    rules: [
                        {label: 'Full Expensing', text: 'å…¨æ–°ä¸»æ± èµ„äº§ -> 100% FYA'},
                        {label: 'AIA', text: 'Â£1,000,000 (ç”¨äºäºŒæ‰‹/SRP)'},
                        {label: 'SRP', text: 'å…¨æ–° -> 50% FYA; ä½™é¢ -> 6% WDA'}
                    ],
                    q_scenario: 'å…¬å¸è´­ä¹°å…¨æ–°æœºå™¨ Â£2m (Main Pool)ã€‚',
                    q_answer: `ç›´æ¥ä½¿ç”¨ <b>Full Expensing</b>ã€‚
Â£2,000,000 Ã— 100% = Â£2,000,000 Allowancesã€‚
å½“æœŸåˆ©æ¶¦ç›´æ¥æŠµå‡ Â£2mã€‚`,
                    note: 'Full Expensing ä¸é€‚ç”¨äºæ±½è½¦ (Cars)ã€‚'
                }
            },
            // --- 3. CGT ---
            {
                id: '3', name: 'CGT\nèµ„æœ¬åˆ©å¾—', category: 'CGT', color: palette.cgt, size: 45,
                info: {
                    def: 'ä¸ªäººèµ„äº§å¤„ç½®ç¨ã€‚FA24 ä½å®…ç¨ç‡é™ä½ã€‚',
                    rules: [
                        {label: 'AEA', text: '<span class="hl-red">Â£3,000</span> (å…ç¨é¢)'},
                        {label: 'Residential', text: '18% (Basic) / <span class="hl-red">24%</span> (Higher)'},
                        {label: 'Other', text: '10% / 20%'}
                    ],
                    q_scenario: 'é«˜ç¨ç‡è€…å–æŠ•èµ„æˆ¿è·åˆ© Â£20,000ã€‚',
                    q_answer: `1. æŠµæ‰£ AEA: 20,000 - 3,000 = Â£17,000
2. ç¨ç‡: 24% (FA24 æ–°ç¨ç‡)
3. Tax = 17,000 Ã— 24% = <b>Â£4,080</b>`,
                    note: 'ä½å®…é«˜ç¨ç‡ä¸å†æ˜¯ 28%ï¼'
                }
            },
            {
                id: '3.1', name: 'BADR\nå•†ä¸šèµ„äº§', category: 'CGT', color: palette.cgt, size: 35,
                info: {
                    def: 'Business Asset Disposal Relief (10% ç¨ç‡)ã€‚',
                    rules: [
                        {label: 'Rate', text: '10%'},
                        {label: 'Limit', text: 'Lifetime Â£1 million'}
                    ],
                    q_scenario: 'å–å…¬å¸èµš Â£1.2m (ç¬¦åˆæ¡ä»¶)ã€‚',
                    q_answer: `1. å‰ Â£1m @ 10% = Â£100,000
2. å‰©ä½™ Â£200k (æ‰£é™¤ 3k AEA) @ 20% = Â£39,400
<b>Total = Â£139,400</b>`,
                    note: 'è¶…å‡º Â£1m éƒ¨åˆ†å›å½’æ­£å¸¸ç¨ç‡ã€‚'
                }
            },
            // --- 4. IHT ---
            {
                id: '4', name: 'IHT\né—äº§ç¨', category: 'IHT', color: palette.iht, size: 45,
                info: {
                    def: '7å¹´åŸåˆ™ + æ­»äº¡ç¨ã€‚',
                    rules: [
                        {label: 'NRB', text: 'Â£325,000'},
                        {label: 'RNRB', text: 'Â£175,000 (ç›´ç³»åä»£)'},
                        {label: 'Rate', text: '40% (Death)'}
                    ],
                    q_scenario: 'é—äº§ Â£600k (å«æˆ¿ Â£300k)ã€‚ç•™ç»™å„¿å­ã€‚æ— ç”Ÿå‰èµ ä¸ã€‚',
                    q_answer: `1. å…ç¨é¢: 325k + 175k = Â£500k
2. åº”ç¨: 600k - 500k = Â£100k
3. Tax: 100k Ã— 40% = <b>Â£40,000</b>`,
                    note: 'é…å¶ (Spouse) ç»§æ‰¿å®Œå…¨å…ç¨ã€‚'
                }
            },
            // --- 5. VAT ---
            {
                id: '5', name: 'VAT\nå¢å€¼ç¨', category: 'VAT', color: palette.vat, size: 45,
                info: {
                    def: 'æ³¨å†Œä¸è®¡ç®—ã€‚',
                    rules: [
                        {label: 'Registration', text: '> <span class="hl-red">Â£90,000</span> (FA24)'},
                        {label: 'Deregistration', text: '< Â£88,000'}
                    ],
                    q_scenario: 'å•†å“æ ‡ä»· Â£100ã€‚5% PPDã€‚å®¢æˆ·å®é™…ä»˜æ¬¾ Â£95ã€‚',
                    q_answer: `VAT åŸºäºå®é™…ä»˜æ¬¾ã€‚
VAT = Â£95 Ã— 20% = <b>Â£19</b>`,
                    note: 'æ³¨å†Œé—¨æ§›å·²ä¸Šè°ƒè‡³ 90kã€‚'
                }
            }
        ];

        const links = [
            { source: '0', target: '1' }, { source: '1', target: '1.1' },
            { source: '0', target: '2' }, { source: '2', target: '2.1' },
            { source: '0', target: '3' }, { source: '3', target: '3.1' },
            { source: '0', target: '4' },
            { source: '0', target: '5' }
        ];

        // ================= ECharts é…ç½® =================
        const option = {
            backgroundColor: 'transparent',
            series: [{
                type: 'graph',
                layout: 'force',
                data: data,
                links: links,
                roam: true,
                zoom: 0.85, // é»˜è®¤ç¼©æ”¾æ¯”ä¾‹ï¼Œé€‚åº”æ‰‹æœºå±å¹•
                label: {
                    show: true,
                    position: 'bottom',
                    color: '#555',
                    fontSize: 11,
                    fontWeight: 'bold',
                    formatter: '{b}'
                },
                itemStyle: {
                    borderColor: '#fff',
                    borderWidth: 2,
                    shadowBlur: 10,
                    shadowColor: 'rgba(0,0,0,0.1)'
                },
                lineStyle: {
                    color: '#bdc3c7',
                    curveness: 0.1,
                    width: 1.5,
                    opacity: 0.6
                },
                force: {
                    repulsion: 300, // èŠ‚ç‚¹é—´è·
                    edgeLength: 90, // è¿çº¿é•¿åº¦
                    gravity: 0.05   // å¼•åŠ›ï¼Œè¶Šå°è¶Šåˆ†æ•£
                }
            }]
        };

        myChart.setOption(option);
        
        // çª—å£å¤§å°æ”¹å˜è‡ªé€‚åº”
        window.addEventListener('resize', function() {
            myChart.resize();
        });

        // ================= äº¤äº’é€»è¾‘ =================
        const mask = document.getElementById('mask');
        const sheet = document.getElementById('sheet');
        const nodeCategory = document.getElementById('nodeCategory');
        const nodeTitle = document.getElementById('nodeTitle');
        const nodeContent = document.getElementById('nodeContent');

        // ç›‘å¬ç‚¹å‡»äº‹ä»¶ (å…¼å®¹ PC å’Œ ç§»åŠ¨ç«¯)
        myChart.on('click', function(params) {
            if (params.data && params.data.info) {
                openSheet(params.data);
            }
        });

        function openSheet(node) {
            const info = node.info;
            
            // è®¾ç½®å¤´éƒ¨
            nodeCategory.innerText = node.category;
            nodeCategory.style.backgroundColor = node.color;
            nodeTitle.innerText = node.name.replace('\n', ' ');
            nodeTitle.style.color = node.color;

            // ç”Ÿæˆå†…å®¹
            let html = '';

            // 1. å®šä¹‰
            html += `<div class="def-box">
                        <div class="def-title">CORE DEFINITION</div>
                        <div class="def-text">${info.def}</div>
                     </div>`;

            // 2. è§„åˆ™
            if (info.rules) {
                html += `<div class="def-title">KEY RULES (FA24)</div>
                         <div class="rule-grid">`;
                info.rules.forEach(r => {
                    html += `<div class="rule-item">
                                <span class="rule-label" style="color:${node.color}">${r.label}</span>
                                ${r.text}
                             </div>`;
                });
                html += `</div>`;
            }

            // 3. ç»¼åˆé¢˜ (å¸¦æŠ˜å )
            if (info.q_scenario) {
                html += `<div class="exam-card">
                            <div class="exam-head">ğŸ”¥ COMPREHENSIVE QUESTION</div>
                            <div class="exam-body">
                                <div style="margin-bottom:10px;">${info.q_scenario}</div>
                                <div style="font-weight:bold; color:#2c3e50; margin-bottom:10px;">Task: ${info.q_task}</div>
                                <details>
                                    <summary>Tap to Reveal Answer</summary>
                                    <div class="solution-area">${info.q_answer}</div>
                                    <div class="lecturer-note">ğŸ’¡ <b>Marker's Note:</b><br>${info.note}</div>
                                </details>
                            </div>
                         </div>`;
            }

            nodeContent.innerHTML = html;
            
            // æ˜¾ç¤º
            mask.classList.add('active');
            sheet.classList.add('active');
        }

        function closeSheet() {
            mask.classList.remove('active');
            sheet.classList.remove('active');
        }

    </script>
</body>
</html>

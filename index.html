<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ACCA TX (UK) Master Guide V15</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        /* === 1. æ²‰æµ¸å¼åº•å±‚ (ä¿®å¤æ»šåŠ¨å†²çª) === */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            margin: 0; padding: 0; overflow: hidden; 
            background-color: #f4f7f6; /* ææ·¡æŠ¤çœ¼èƒŒæ™¯ */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        }
        
        /* ç¡®ä¿å›¾è¡¨å®¹å™¨å…¨å±ä¸”å±‚çº§æ­£ç¡® */
        #main { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }

        /* === 2. ç•Œé¢ UI (ç‚¹å‡»ç©¿é€ä¿®å¤) === */
        /* é¡¶éƒ¨æ  - è®¾ç½® pointer-events: none é˜²æ­¢é®æŒ¡ç‚¹å‡» */
        .header {
            position: fixed; top: 0; left: 0; right: 0; height: 60px;
            padding: 0 20px; z-index: 10;
            display: flex; align-items: center; justify-content: center;
            pointer-events: none; /* å…³é”®ä¿®å¤ï¼šè®©ç‚¹å‡»ç©¿é€åˆ°å›¾è¡¨ */
            background: linear-gradient(to bottom, rgba(244,247,246,0.9), rgba(244,247,246,0));
        }
        /* æ ‡é¢˜æ–‡å­—æœ¬èº«ä¸éœ€è¦ç©¿é€ */
        .header h1 { 
            font-size: 15px; color: #7f8c8d; font-weight: 700; letter-spacing: 1px; 
            margin: 0; pointer-events: auto; 
            background: rgba(255,255,255,0.8); padding: 6px 12px; border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* åº•éƒ¨æç¤º */
        .tip {
            position: fixed; bottom: 30px; width: 100%; text-align: center;
            color: #bdc3c7; font-size: 12px; pointer-events: none; z-index: 5;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% {opacity:0.6} 50% {opacity:1} 100% {opacity:0.6} }

        /* === 3. åº•éƒ¨è¯¦æƒ…å¡ç‰‡ (äº¤äº’æ ¸å¿ƒ) === */
        .mask {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.2); z-index: 99; display: none;
            backdrop-filter: blur(2px); transition: opacity 0.3s;
        }
        .mask.show { display: block; opacity: 1; }

        .sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #fff; z-index: 100;
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.08);
            transform: translateY(110%); transition: transform 0.35s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column; max-height: 85vh;
        }
        .sheet.show { transform: translateY(0); }

        /* å¡ç‰‡å¤´éƒ¨ */
        .sheet-head {
            padding: 18px 24px; border-bottom: 1px solid #f0f0f0;
            display: flex; justify-content: space-between; align-items: center;
            background: #fff; border-radius: 24px 24px 0 0; flex-shrink: 0;
        }
        .sheet-title { font-size: 18px; font-weight: 700; color: #2c3e50; margin: 0; display: flex; align-items: center; }
        .sheet-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 10px; }
        .close-btn { font-size: 24px; color: #b2bec3; cursor: pointer; padding: 5px; }

        /* å¡ç‰‡å†…å®¹åŒº */
        .sheet-body { padding: 0 20px 40px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        /* --- å†…å®¹ç»„ä»¶æ ·å¼ --- */
        .section { margin-top: 25px; }
        
        /* æ ‡é¢˜å¸¦å·¦ä¾§è‰²æ¡ */
        .sec-title { 
            font-size: 13px; font-weight: 800; color: #34495e; margin-bottom: 10px; 
            text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center;
        }
        .sec-title::before { content:''; display:inline-block; width:4px; height:14px; margin-right:8px; border-radius:2px; background: #ccc; }

        /* æ–‡æœ¬ */
        .text-box { font-size: 15px; line-height: 1.7; color: #555; text-align: justify; }
        .text-box li { margin-bottom: 6px; }
        
        /* è§„åˆ™å¡ç‰‡ */
        .rule-card {
            background: #f9fbfb; border: 1px solid #eef2f3; border-radius: 8px;
            padding: 12px 15px; margin-bottom: 10px;
        }
        .rule-head { font-size: 12px; font-weight: 700; margin-bottom: 4px; color: #7f8c8d; }
        
        /* æ¡ˆä¾‹ç›’å­ */
        .case-box {
            background: #fff; border: 1px solid #eee; border-radius: 10px;
            padding: 0; margin-top: 15px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        .case-head { padding: 12px 15px; background: #fcfdfd; border-bottom: 1px solid #f0f0f0; font-weight: 700; font-size: 14px; color: #2c3e50; }
        .case-content { padding: 15px; font-size: 14px; color: #444; line-height: 1.6; }
        
        /* æŠ˜å è§£æ */
        details { border-top: 1px solid #f5f5f5; }
        summary {
            padding: 12px 15px; cursor: pointer; font-size: 13px; color: #3498db; font-weight: 600;
            list-style: none; display: flex; justify-content: space-between;
        }
        summary::after { content: '+ è§£æ'; color: #bdc3c7; }
        details[open] summary { color: #7f8c8d; background: #fafafa; }
        details[open] summary::after { content: '- æ”¶èµ·'; }
        
        .ans { 
            padding: 15px; background: #fbfbfb; font-family: "Menlo", monospace; 
            font-size: 13px; color: #333; line-height: 1.6; white-space: pre-wrap; border-top: 1px dashed #eee;
        }

        /* BOSS é¢˜ */
        .boss-container { border: 2px solid #ffcb89; border-radius: 10px; overflow: hidden; margin-top: 20px; }
        .boss-header { background: #ffeaa7; color: #d35400; padding: 12px 15px; font-weight: 800; font-size: 14px; }

        /* é«˜äº® */
        .hl { font-weight: bold; color: #2c3e50; background: #e8f6f3; padding: 0 4px; border-radius: 3px; }

    </style>
</head>
<body>

    <div class="header">
        <h1>TX (UK) <span style="color:#bbb">|</span> Master Guide</h1>
    </div>

    <div id="main"></div>
    <div class="tip">ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…</div>

    <div class="mask" id="mask" onclick="closeSheet()"></div>
    <div class="sheet" id="sheet">
        <div class="sheet-head">
            <div class="sheet-title">
                <div class="sheet-dot" id="sheetDot"></div>
                <span id="sheetTitle">Title</span>
            </div>
            <div class="close-btn" onclick="closeSheet()">Ã—</div>
        </div>
        <div class="sheet-body" id="sheetContent">
            </div>
    </div>

    <script type="text/javascript">
        var chartDom = document.getElementById('main');
        var myChart = echarts.init(chartDom, null, {renderer: 'canvas'}); // å¼ºåˆ¶Canvasæ¸²æŸ“ä»¥æå‡ç§»åŠ¨ç«¯æ€§èƒ½

        // ================= é…è‰²ç³»ç»Ÿ (è«å…°è¿ª) =================
        const c = {
            iht: '#1abc9c',     // è–„è·ç»¿ (IHTä¸»è‰²)
            iht_light: '#a8e6cf',
            cgt: '#a29bfe',     // æš®å±±ç´« (CGTä¸»è‰²)
            cgt_light: '#dcd6f7',
            root: '#34495e',    // æ·±ç° (Root)
            boss: '#fdcb6e'     // æš–æ©™ (BOSS)
        };

        // ================= æ•°æ®å†…å®¹åº“ =================
        const data = [
            // --- Root ---
            {
                id: '0', name: 'ACCA TX\n(UK)', category: 'ROOT', symbolSize: 55,
                itemStyle: { color: c.root, shadowBlur: 15, shadowColor: 'rgba(0,0,0,0.3)' },
                info: { def: 'FA2024 æ ¸å¿ƒå¤ä¹ å›¾è°± (June 25 - Mar 26)ã€‚<br>ç‚¹å‡»åˆ†æ”¯æŸ¥çœ‹ <b>IHT (é—äº§ç¨)</b> å’Œ <b>CGT (èµ„æœ¬åˆ©å¾—ç¨)</b> è¯¦è§£ã€‚' }
            },

            // =================== IHT æ¨¡å— (è–„è·ç»¿) ===================
            {
                id: 'iht_root', name: 'IHT\né—äº§ç¨', category: 'IHT', symbolSize: 45,
                itemStyle: { color: c.iht },
                info: {
                    def: 'åŸºäº<b>ä»·å€¼è½¬ç§» (Transfer of Value)</b>ï¼Œå³æèµ å¯¼è‡´æèµ è€…è´¢å¯Œå‡å°‘çš„é‡‘é¢ã€‚',
                    rules: [
                        {t: 'Nil Rate Band (NRB)', c: 'Â£325,000'},
                        {t: 'Resi NRB (RNRB)', c: 'Â£175,000'},
                        {t: 'Death Rate', c: '40%'},
                        {t: 'Lifetime Rate', c: '20% (Trustee) / 25% (Donor)'}
                    ]
                }
            },
            {
                id: 'iht_life', name: 'Lifetime\nç”Ÿå‰è½¬ç§»', category: 'IHT', symbolSize: 35, itemStyle: { color: c.iht_light },
                info: {
                    def: 'ç”Ÿå‰ç¤¼ç‰©çš„ä¸‰ç±»å¤„ç†æ–¹å¼ï¼š',
                    rules: [
                        {t: 'A. Exempt (è±å…)', c: 'Spouse (æ— é™), AE (Â£3k), Marriage (Â£5k/2.5k/1k), Small Gifts (Â£250)ã€‚'},
                        {t: 'B. PET (ä¸ªäºº)', c: 'ç”Ÿå‰ä¸äº¤ç¨ã€‚æ´»è¿‡7å¹´å…ç¨ï¼›7å¹´å†…æ­»è¡¥äº¤ã€‚'},
                        {t: 'C. CLT (ä¿¡æ‰˜)', c: 'ç«‹å³äº¤ç¨ (20%)ã€‚7å¹´ç´¯ç§¯åŸåˆ™ã€‚'}
                    ],
                    cases: [
                        {t: 'æ¡ˆä¾‹ 1: ç²¾æ‰“ç»†ç®—çš„çˆ·çˆ·', s: '2024å¹´é€å­™å­ç»“å©šç¤¼ç‰© Â£8,000ã€‚ä¸Šå¹´æœªèµ äºˆã€‚', a: 'Transfer: Â£8,000\n(-) Marriage: (Â£2,500)\n(-) AE Cur: (Â£3,000)\n(-) AE BF: (Â£2,500)\n= Chargeable: Â£0'},
                        {t: 'æ¡ˆä¾‹ 2: å¯Œè±ªçš„ä¿¡æ‰˜ (CLT)', s: 'è½¬å…¥ä¿¡æ‰˜ Â£400,000ã€‚æ­¤å‰7å¹´æ—  CLTã€‚', a: 'Gross: Â£400,000\nLess NRB: (Â£325,000)\nTaxable: Â£75,000\nTax @ 20% = Â£15,000'}
                    ]
                }
            },
            {
                id: 'iht_death', name: 'Death Tax\næ­»åè¿½æº¯', category: 'IHT', symbolSize: 35, itemStyle: { color: c.iht_light },
                info: {
                    def: 'æ­»å‰ 7 å¹´å†…çš„ PET/CLT éœ€é‡ç®—ã€‚',
                    rules: [
                        {t: 'æ­¥éª¤', c: '1. æ‰¾7å¹´å†…ç¤¼ç‰© 2. æ‰£ NRB (Look back 7 yrs from GIFT) 3. ç®— 40% ç¨ 4. Taper Relief'},
                        {t: 'Taper', c: '3-4yr: 20% off ... 6-7yr: 80% off'}
                    ],
                    cases: [
                        {t: 'æ¡ˆä¾‹ 3: ä¸å¹¸çš„å¯Œè±ª', s: 'é€å‡º Â£100k PET å 4.5 å¹´å»ä¸–ã€‚', a: 'Gross: Â£100,000\nAvail NRB: Â£325,000\nTax: Â£0 (Covered)\n(ä½†åƒæ‰äº† Â£100k NRBï¼Œå½±å“åç»­é—äº§ç¨)'}
                    ]
                }
            },
            {
                id: 'iht_estate', name: 'Estate\næ­»äº¡é—äº§', category: 'IHT', symbolSize: 35, itemStyle: { color: c.iht_light },
                info: {
                    def: 'æ­»äº¡æ—¶èµ„äº§æ€»å€¼ (Probate Value)ã€‚',
                    rules: [
                        {t: 'RNRB Â£175k', c: 'æ¡ä»¶: ä¸»å±…æ‰€ + ç›´ç³»åä»£ã€‚'},
                        {t: 'è®¡ç®—', c: 'Assets - Debts - Exemptions = Chargeable Estate'}
                    ],
                    cases: [
                        {t: 'æ¡ˆä¾‹ 4: æœ€åçš„é—äº§', s: 'ç•™ç»™å­™å­æˆ¿Â£400k + å…¶ä»–Â£200kã€‚', a: 'Estate: Â£600,000\n(-) RNRB: (Â£175,000)\n(-) NRB: (Â£325,000)\nTaxable: Â£100,000\nTax @ 40% = Â£40,000'}
                    ]
                }
            },
            {
                id: 'iht_boss', name: 'BOSS\nç»¼åˆå¤§é¢˜', category: 'IHT', symbolSize: 45, itemStyle: { color: c.boss, shadowBlur: 10, shadowColor: c.boss },
                info: {
                    isBoss: true, title: 'ğŸ‘¹ IHT ç»ˆææˆ˜ï¼šNRB è€—å°½',
                    scen: 'Mr. Bond (2026å¹´3æœˆå»ä¸–)ã€‚\n1. 2019.8 CLT Â£280k\n2. 2021.10 PET Â£150k\n3. Estate: æˆ¿Â£500k(ç»™å„¿), è‚¡Â£300k, å€ºÂ£25kã€‚',
                    ans: `<b>Step 1: ç”Ÿå‰å ç”¨æ£€æŸ¥</b>
1. CLT (Â£280k): å ç”¨ Â£280k NRBã€‚
   å‰©ä½™ NRB = 45kã€‚
2. PET (Â£150k): å˜æˆ Chargeableã€‚
   åƒæ‰å‰©ä½™ 45k NRB å¹¶æº¢å‡ºã€‚
   <b>ç»“è®ºï¼šæ­»äº¡æ—¶ NRB = 0ã€‚</b>

<b>Step 2: é—äº§ç¨è®¡ç®—</b>
Net Estate: Â£775,000 (Â£800k - Â£25k)
Less RNRB: (Â£175,000)
Less NRB: (Â£0)
Taxable: Â£600,000
<b>Tax @ 40% = Â£240,000</b>`
                }
            },

            // =================== CGT æ¨¡å— (æš®å±±ç´«) ===================
            {
                id: 'cgt_root', name: 'CGT\nèµ„æœ¬åˆ©å¾—', category: 'CGT', symbolSize: 50,
                itemStyle: { color: c.cgt },
                info: {
                    def: 'å¤„ç½®èµ„äº§åˆ©å¾—ç¨ã€‚FA24 ä½å®…ç¨ç‡é™ä½ã€‚',
                    rules: [
                        {t: 'AEA', c: 'Â£3,000'},
                        {t: 'Rates', c: 'Normal: 10/20% | Resi: 18/24%'},
                        {t: 'BADR', c: '10% (Limit Â£1m)'}
                    ]
                }
            },
            {
                id: 'cgt_comp', name: 'Rules\nè®¡ç®—è§„åˆ™', category: 'CGT', symbolSize: 35, itemStyle: { color: c.cgt_light },
                info: {
                    def: 'è®¡ç®—æ¡†æ¶ä¸ Loss æŠµæ‰£ã€‚',
                    rules: [{t: 'Losses', c: 'CY Loss å¿…é¡»å…¨æŠµ; BF Loss åªæŠµåˆ° AEA ä¸ºæ­¢ã€‚'}],
                    cases: [{t: 'æ¡ˆä¾‹: æˆ¿äº§ vs è‚¡ç¥¨', s: 'å–æˆ¿èµšÂ£20k (High Rate)ï¼Œå–è‚¡èµšÂ£10kã€‚', a: 'AEA ä¼˜å…ˆæŠµæ‰£æˆ¿äº§ (24% > 20%)ã€‚\nResi Taxable: 17k @ 24% = Â£4,080\nShare Taxable: 10k @ 20% = Â£2,000'}]
                }
            },
            {
                id: 'cgt_asset', name: 'Assets\nç‰¹æ®Šèµ„äº§', category: 'CGT', symbolSize: 35, itemStyle: { color: c.cgt_light },
                info: {
                    def: 'Chattels & Sharesã€‚',
                    rules: [
                        {t: 'Chattels', c: 'Â£6k è§„åˆ™ã€‚Marginal Relief: 5/3 x (Proceeds - 6k)ã€‚'},
                        {t: 'Shares', c: 'åŒ¹é…: 1. Same Day 2. Next 30 Days 3. Poolã€‚'}
                    ]
                }
            },
            {
                id: 'cgt_boss', name: 'BOSS\nç»¼åˆå¤§é¢˜', category: 'CGT', symbolSize: 45, itemStyle: { color: c.boss, shadowBlur: 10, shadowColor: c.boss },
                info: {
                    isBoss: true, title: 'ğŸ‘¹ CGT ç»ˆææˆ˜ï¼šMr. Lucky',
                    scen: 'Mr. Lucky (High Rate) 2025/26:\n1. å–èŠ±ç“¶: å–Â£8k, ä¹°Â£4kã€‚\n2. å–å’–å•¡åº—: èµšÂ£200k (BADR)ã€‚\n3. å–è‚¡ç¥¨: 1000è‚¡@Â£5 (Pool Cost Â£2.67)ã€‚\n4. BF Loss Â£500ã€‚',
                    ans: `<b>Step 1: Chattel (Vase)</b>
Marginal: 5/3 Ã— (8000 - 6000) = Â£3,333.
(Take lower) -> <b>Â£3,333</b>

<b>Step 2: Business (BADR)</b>
Â£200,000 @ 10% = <b>Â£20,000</b>

<b>Step 3: Shares</b>
Gain = 1000 Ã— (5 - 2.67) = <b>Â£2,333</b>

<b>Step 4: Total Tax</b>
Total Gains = 205,666
(-) Loss Â£500 (-) AEA Â£3,000
Taxable = Â£202,166
(BADR @ 10%; Rest @ 20%)
<b>Total Tax = Â£20,433</b>`
                }
            }
        ];

        const links = [
            { source: '0', target: 'iht_root' },
            { source: '0', target: 'cgt_root' },
            { source: 'iht_root', target: 'iht_life' },
            { source: 'iht_life', target: 'iht_death' },
            { source: 'iht_death', target: 'iht_estate' },
            { source: 'iht_estate', target: 'iht_boss' },
            { source: 'cgt_root', target: 'cgt_comp' },
            { source: 'cgt_comp', target: 'cgt_asset' },
            { source: 'cgt_asset', target: 'cgt_boss' }
        ];

        // ================= ECharts é…ç½® =================
        const option = {
            backgroundColor: 'transparent',
            series: [{
                type: 'graph',
                layout: 'force',
                data: data,
                links: links,
                roam: true,
                zoom: 0.85, // å®Œç¾é€‚é…æ‰‹æœºé¦–å±
                label: {
                    show: true,
                    position: 'bottom',
                    color: '#7f8c8d',
                    fontSize: 11,
                    fontWeight: 'bold',
                    formatter: '{b}',
                    distance: 8
                },
                itemStyle: { borderColor: '#fff', borderWidth: 2 },
                lineStyle: {
                    color: '#bdc3c7',
                    curveness: 0.2, // ä¸æ»‘æ›²çº¿
                    width: 1.5,
                    opacity: 0.6
                },
                force: {
                    repulsion: 400, // èŠ‚ç‚¹é—´è·é€‚ä¸­
                    edgeLength: 90,
                    gravity: 0.06
                }
            }]
        };

        myChart.setOption(option);
        window.addEventListener('resize', () => myChart.resize());

        // ================= äº¤äº’é€»è¾‘ (ä¿®å¤ç‚¹å‡») =================
        const mask = document.getElementById('mask');
        const sheet = document.getElementById('sheet');
        
        myChart.on('click', function(params) {
            if (params.data && params.data.info) openSheet(params.data);
        });

        function openSheet(node) {
            const info = node.info;
            const color = node.itemStyle.color;

            // æ³¨å…¥æ ‡é¢˜é¢œè‰²
            document.getElementById('sheetTitle').innerText = node.name.replace('\n', ' ');
            document.getElementById('sheetTitle').style.color = color;
            document.getElementById('sheetDot').style.background = color;
            
            // æ³¨å…¥ CSS å˜é‡ä»¥æ§åˆ¶è¾¹æ¡†é¢œè‰²
            document.getElementById('sheetContent').innerHTML = renderContent(info, color);
            
            mask.classList.add('active');
            sheet.classList.add('active');
        }

        function renderContent(info, color) {
            let html = '';
            
            if (info.isBoss) {
                html += `<div class="boss-container">
                            <div class="boss-header">ğŸ”¥ ${info.title}</div>
                            <div class="boss-body" style="white-space:pre-wrap; padding:15px; font-size:14px; color:#333">${info.scen}</div>
                         </div>
                         <details open><summary style="color:#d35400">è§£æè¿‡ç¨‹</summary><div class="ans">${info.ans}</div></details>`;
            } else {
                if (info.def) html += `<div class="def-box"><div class="sec-title" style="color:${color}">Core Definition</div><div class="text-box">${info.def}</div></div>`;
                
                if (info.rules) {
                    html += `<div class="section">`;
                    info.rules.forEach(r => {
                        html += `<div class="rule-card">
                                    <div class="rule-head" style="color:${color}">${r.t}</div>
                                    <div class="text-box">${r.c}</div>
                                 </div>`;
                    });
                    html += `</div>`;
                }

                if (info.cases) {
                    info.cases.forEach(c => {
                        html += `<div class="case-box" style="border-left-color:${color}">
                                    <div class="case-head" style="color:${color}">ğŸŒ° ${c.t}</div>
                                    <div class="case-content">${c.s}</div>
                                    <details><summary>è§£æ</summary><div class="ans">${c.a}</div></details>
                                 </div>`;
                    });
                }
            }
            return html;
        }

        function closeSheet() {
            mask.classList.remove('active');
            sheet.classList.remove('active');
        }
    </script>
</body>
</html>

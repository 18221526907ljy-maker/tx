<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ACCA TX (UK) FA2024 ç»¼åˆæ¼”ç»ƒå›¾è°±</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* === åŸºç¡€æ ·å¼ === */
        body { margin: 0; padding: 0; overflow: hidden; background-color: #fdfbf7; font-family: -apple-system, "PingFang SC", sans-serif; }
        #main { width: 100vw; height: 100vh; }

        /* é¡¶éƒ¨æ  */
        .header {
            position: absolute; top: 0; left: 0; right: 0; z-index: 10;
            padding: 15px 20px; background: rgba(253, 251, 247, 0.9);
            backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { font-size: 18px; color: #2d3436; margin: 0; font-weight: 700; }
        .header span { font-size: 11px; background: #2d3436; color: #fff; padding: 3px 8px; border-radius: 4px; }

        /* åº•éƒ¨è¯¦æƒ…å¼¹çª— (Bottom Sheet) */
        .sheet-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3); z-index: 99; display: none;
            backdrop-filter: blur(2px);
        }
        .sheet-overlay.active { display: block; animation: fadeIn 0.3s; }

        .sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #fff; border-radius: 20px 20px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
            z-index: 100; max-height: 85vh; display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .sheet.active { transform: translateY(0); }

        /* å¼¹çª—å†…å®¹åŒº */
        .sheet-header { padding: 20px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .sheet-title { margin: 0; font-size: 20px; font-weight: 700; color: #333; }
        .sheet-close { font-size: 28px; color: #ccc; cursor: pointer; line-height: 1; }
        
        .sheet-body { padding: 20px; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        /* å†…å®¹æ¨¡å—æ ·å¼ */
        .section { margin-bottom: 25px; }
        .section-title { font-size: 12px; font-weight: 800; color: #b2bec3; margin-bottom: 8px; letter-spacing: 1px; text-transform: uppercase; }
        
        .text-box { background: #f9f9f9; border-radius: 8px; padding: 12px; color: #555; font-size: 14px; line-height: 1.6; border-left: 3px solid #dfe6e9; }
        .text-box strong { color: #2d3436; }

        /* ç»¼åˆé¢˜å¡ç‰‡æ ·å¼ */
        .exam-card { background: #fff; border: 1px solid #eee; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .exam-header { background: #fdf0ed; padding: 10px 15px; border-bottom: 1px solid #fcece8; display: flex; align-items: center; }
        .exam-icon { margin-right: 8px; font-size: 16px; }
        .exam-title { font-size: 14px; font-weight: 700; color: #e17055; }
        .exam-content { padding: 15px; font-size: 14px; color: #2d3436; line-height: 1.7; }

        /* æŠ˜å è§£ææŒ‰é’® (æ ¸å¿ƒåŠŸèƒ½) */
        details { margin-top: 10px; border-top: 1px dashed #eee; }
        details[open] summary ~ * { animation: sweep .5s ease-in-out; }
        
        summary {
            padding: 12px 0; cursor: pointer; font-size: 13px; font-weight: 600; color: #0984e3;
            display: flex; align-items: center; list-style: none; outline: none;
        }
        summary::after { content: 'ğŸ‘‡ ç‚¹å‡»æŸ¥çœ‹è§£æ & æ¿ä¹¦'; margin-left: auto; font-size: 12px; color: #aaa; font-weight: normal;}
        details[open] summary::after { content: 'ğŸ‘† æ”¶èµ·'; }
        
        .answer-box {
            background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 10px;
            font-family: 'Menlo', monospace; font-size: 13px; color: #2c3e50; border: 1px solid #dbe9f6;
        }
        .lecturer-note {
            background: #fff8e1; padding: 10px; border-radius: 6px; margin-top: 10px;
            border: 1px solid #ffe0b2; color: #d35400; font-size: 13px; font-style: italic;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes sweep { 0% {opacity: 0; transform: translateY(-10px)} 100% {opacity: 1; transform: translateY(0)} }
        
        .highlight { background: #fff0f0; color: #c0392b; padding: 0 4px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <h1>ACCA TX (UK) <span style="color:#aaa; font-weight:400;">| Master Class</span></h1>
        <span>FA2024</span>
    </div>

    <div id="main"></div>

    <div class="sheet-overlay" id="overlay" onclick="closeSheet()"></div>
    <div class="sheet" id="sheet">
        <div class="sheet-header">
            <div class="sheet-title" id="nodeTitle">Title</div>
            <div class="sheet-close" onclick="closeSheet()">Ã—</div>
        </div>
        <div class="sheet-body" id="nodeContent">
            </div>
    </div>

    <script type="text/javascript">
        var chartDom = document.getElementById('main');
        var myChart = echarts.init(chartDom);

        // ================= å†…å®¹æ•°æ®åº“ (FA2024 æ·±åº¦å®šåˆ¶) =================
        // åŒ…å«ï¼šå®šä¹‰ã€è§„åˆ™ã€é«˜éš¾ç»¼åˆé¢˜ã€è§£æã€é¿å‘
        
        const nodes = [
            // --- Income Tax ---
            {
                id: '1', name: 'IT: ç»¼åˆè®¡ç®—\nComprehensive', category: 0, symbolSize: 70,
                color: '#ff7675',
                info: {
                    def: 'ä¸ªäººæ‰€å¾—ç¨ç»¼åˆè®¡ç®—æ¡†æ¶ (Income Tax Computation)',
                    rule: '1. åŒºåˆ† NS / Sav / Divã€‚<br>2. å‡å» Reliefs (å¦‚è´·æ¬¾åˆ©æ¯) å¾—å‡º Net Incomeã€‚<br>3. å‡å» PA å¾—å‡º Taxable Incomeã€‚<br>4. æ‰©å±•ç¨ç‡å¸¦ (Gift Aid/Pension)ã€‚',
                    question: `
                        <b>Scenario:</b><br>
                        èµµå…ˆç”Ÿ 23/24 å¹´åº¦ä¿¡æ¯å¦‚ä¸‹ï¼š<br>
                        â€¢ å·¥èµ„ (Salary): Â£110,000<br>
                        â€¢ é“¶è¡Œåˆ©æ¯ (Interest): Â£3,000<br>
                        â€¢ è‚¡æ¯ (Dividends): Â£5,000<br>
                        â€¢ æ”¯ä»˜ Gift Aid (Net): Â£8,000<br>
                        <br>
                        <b>Requirement:</b> è®¡ç®—èµµå…ˆç”Ÿ 2023/24 åº”äº¤çš„ä¸ªäººæ‰€å¾—ç¨ (Income Tax Liability)ã€‚
                    `,
                    answer: `
                        <b>Step 1: ANI Calculation (æ£€æŸ¥ PA)</b><br>
                        Net Income = 110k + 3k + 5k = Â£118,000<br>
                        Gross Gift Aid = Â£8,000 Ã— 100/80 = Â£10,000<br>
                        ANI = 118,000 - 10,000 = <b>Â£108,000</b><br>
                        <br>
                        PA Reduction = (108,000 - 100,000) / 2 = Â£4,000<br>
                        Available PA = 12,570 - 4,000 = <b>Â£8,570</b><br>
                        <br>
                        <b>Step 2: Extend Bands (æ‰©å±•ç¨ç‡å¸¦)</b><br>
                        Basic Band = 37,700 + 10,000 (Gross GA) = <b>Â£47,700</b><br>
                        <br>
                        <b>Step 3: Computation</b><br>
                        Non-Savings (Salary): Â£110,000 - Â£8,570 = Â£101,430<br>
                        â€¢ 37,700 (Basic) ä¸é€‚ç”¨ï¼Œå› è¢«æ‰©å……è‡³47,700<br>
                        â€¢ 47,700 @ 20% = 9,540<br>
                        â€¢ 53,730 @ 40% = 21,492<br>
                        (Total NS Taxable = 101,430)<br>
                        <br>
                        Savings (Â£3,000):<br>
                        â€¢ PSA = Â£500 (Higher Rate Taxpayer)<br>
                        â€¢ 500 @ 0% = 0<br>
                        â€¢ 2,500 @ 40% = 1,000<br>
                        <br>
                        Dividends (Â£5,000):<br>
                        â€¢ Nil Band = Â£500 (FA24)<br>
                        â€¢ 500 @ 0% = 0<br>
                        â€¢ 4,500 @ 33.75% = 1,518.75<br>
                        <br>
                        <b>Total Liability = Â£33,550.75</b>
                    `,
                    note: 'é™·é˜±æç¤ºï¼š1. ANI è®¡ç®—å¿…é¡»å‡å» Gross Gift Aidã€‚2. ç¨ç‡å¸¦æ‰©å±•ä½¿ç”¨çš„æ˜¯ Gross Gift Aidã€‚3. è‚¡æ¯å…ç¨é¢ (DA) åœ¨ FA24 ä¸­å·²é™ä¸º Â£500 (ä¹‹å‰æ˜¯ Â£1000)ã€‚'
                }
            },
            {
                id: '2', name: 'Employment\né›‡ä½£ç¦åˆ©', category: 0, symbolSize: 50,
                color: '#fab1a0',
                info: {
                    def: 'Benefits in Kind (P11D Items)',
                    rule: 'Car Benefit: List Price Ã— CO2% (Base 55g=16%, Max 37%)<br>Fuel Benefit: Â£27,800 Ã— CO2%',
                    question: `
                        <b>Scenario:</b><br>
                        å…¬å¸æä¾›ä¸€è¾†æ±½æ²¹è½¦ (List Price Â£30,000)ï¼Œæ’æ”¾ 103g/kmã€‚å…¬å¸æ”¯ä»˜æ‰€æœ‰ç‡ƒæ²¹ï¼Œå‘˜å·¥æ¯æœˆå‘å…¬å¸æ”¯ä»˜ Â£100 ä½œä¸ºç§ç”¨æ²¹è¡¥ã€‚<br>
                        <b>Requirement:</b> è®¡ç®— Taxable Benefitã€‚
                    `,
                    answer: `
                        <b>1. Car Benefit %</b><br>
                        103g -> Round down to 100g<br>
                        Diff = 100 - 55 = 45g<br>
                        % = 16% + (45/5)% = 25%<br>
                        <br>
                        <b>2. Car Benefit Value</b><br>
                        Â£30,000 Ã— 25% = <b>Â£7,500</b><br>
                        (å‘˜å·¥æ”¯ä»˜çš„æ²¹è´¹ä¸èƒ½æŠµæ‰£è½¦æœ¬èº«çš„ Benefit)<br>
                        <br>
                        <b>3. Fuel Benefit</b><br>
                        Base Â£27,800 Ã— 25% = Â£6,950<br>
                        å‘˜å·¥æ”¯ä»˜ Â£100 Ã— 12 = Â£1,200<br>
                        å› ä¸ºæ²¡æœ‰å…¨é¢å¿è¿˜ç§ç”¨æ²¹è´¹ (Not fully reimbursed)ï¼Œç‡ƒæ²¹ç¦åˆ©ä¸èƒ½å‡å°‘ã€‚<br>
                        Fuel Benefit = <b>Â£6,950</b><br>
                        <br>
                        <b>Total Taxable = Â£14,450</b>
                    `,
                    note: 'Fuel Benefit æ˜¯â€œå…¨æœ‰æˆ–å…¨æ— â€ (All or Nothing)ï¼é™¤éå‘˜å·¥è¿˜æ¸…äº†æ‰€æœ‰ç§ç”¨æ²¹è´¹ï¼Œå¦åˆ™å“ªæ€•å°‘è¿˜ä¸€åˆ†é’±ï¼Œä¹Ÿè¦æŒ‰å…¨é¢äº¤ç¨ã€‚'
                }
            },
            {
                id: '3', name: 'NIC\nç¤¾ä¿æ–°è§„', category: 0, symbolSize: 50,
                color: '#e17055',
                info: {
                    def: 'FA2024 é‡å¤§å˜æ›´ï¼šè´¹ç‡ä¸‹è°ƒ',
                    rule: 'Class 1 Employee: 8% (was 12%)<br>Class 4 Self-employed: 6% (was 9%)',
                    question: `
                        <b>Scenario:</b><br>
                        æŸè‡ªé›‡äººå£« (Sole Trader) 23/24 è´¢å¹´ Trading Profit ä¸º Â£55,000ã€‚<br>
                        <b>Requirement:</b> è®¡ç®— Class 4 NICã€‚
                    `,
                    answer: `
                        <b>Class 4 NIC Calculation:</b><br>
                        Band 1 (Â£12,570 - Â£50,270):<br>
                        (50,270 - 12,570) Ã— <b>6%</b> = Â£2,262<br>
                        <br>
                        Band 2 (Â£50,270+):<br>
                        (55,000 - 50,270) Ã— 2% = Â£94.6<br>
                        <br>
                        <b>Total Class 4 = Â£2,356.60</b>
                    `,
                    note: 'åƒä¸‡è®°ä½ 6% å’Œ 8% è¿™ä¸¤ä¸ªæ–°æ•°å­—ï¼è€ƒè¯•ç›´æ¥ç”¨æ–°ç¨ç‡ã€‚Class 2 NIC ç°åœ¨é€šå¸¸è§†ä¸º 0 (abolished for most cases)ã€‚'
                }
            },

            // --- Corporation Tax ---
            {
                id: '4', name: 'CT: TTP & Tax\nå…¬å¸ç¨ç»¼åˆ', category: 1, symbolSize: 70,
                color: '#74b9ff',
                info: {
                    def: 'å…¬å¸ç¨è®¡ç®—ï¼šTaxable Total Profits (TTP)',
                    rule: 'Limits: Â£50k (19%) - Â£250k (25%)<br>Marginal Relief Fraction: 3/200',
                    question: `
                        <b>Scenario:</b><br>
                        A Ltd (æ— å…³è”å…¬å¸) ä¸šç»©å¦‚ä¸‹ï¼š<br>
                        â€¢ Trading Profit (adj): Â£180,000<br>
                        â€¢ Interest Income: Â£5,000<br>
                        â€¢ Dividends received (FGL): Â£20,000<br>
                        â€¢ QCD (Donations): (Â£2,000)<br>
                        <b>Requirement:</b> è®¡ç®— Corporation Tax Liabilityã€‚
                    `,
                    answer: `
                        <b>1. Calculate TTP</b><br>
                        180,000 + 5,000 - 2,000 = <b>Â£183,000</b><br>
                        (æ³¨æ„ï¼šè‚¡æ¯ä¸è®¡å…¥ TTP)<br>
                        <br>
                        <b>2. Augmented Profits (AP) for Rate</b><br>
                        AP = TTP + FGL (Dividends)<br>
                        AP = 183,000 + 20,000 = <b>Â£203,000</b><br>
                        <br>
                        <b>3. Tax Calculation</b><br>
                        AP åœ¨ Â£50k - Â£250k ä¹‹é—´ï¼Œé€‚ç”¨ Marginal Reliefã€‚<br>
                        Basic Tax: 183,000 (TTP) Ã— 25% = Â£45,750<br>
                        Less: Relief = (250,000 - 203,000) Ã— 3/200 Ã— (183k/203k)<br>
                        *æ³¨ï¼šå¦‚æœæ˜¯åŒä¸€å®¶å…¬å¸ï¼Œæœ€åæ¯”ä¾‹é€šå¸¸å¿½ç•¥æˆ–ä¸º1ï¼Œé™¤éçŸ­è¡¨æœŸã€‚è¿™é‡Œç®€å•å¤„ç†ä¸º (U-AP)*3/200*<br>
                        Relief = 47,000 Ã— 0.015 = Â£705<br>
                        <br>
                        <b>CT Payable = Â£45,045</b>
                    `,
                    note: 'è‚¡æ¯ (Dividends from UK companies) ä¸äº¤ç¨ï¼Œä½†å¿…é¡»åŠ å›è®¡ç®— Augmented Profitsï¼Œå®ƒä¼šæ¨é«˜ä½ çš„ç¨ç‡åŒºé—´ï¼'
                }
            },
            {
                id: '5', name: 'Cap Allowances\nèµ„æœ¬å‡å…', category: 1, symbolSize: 50,
                color: '#0984e3',
                info: {
                    def: 'Full Expensing (FA24)',
                    rule: 'Main Pool (New) -> 100% FYA<br>Special Rate Pool (New) -> 50% FYA<br>AIA -> Â£1m (ç”¨äºäºŒæ‰‹æˆ– SRP ä½™é¢)',
                    question: `
                        <b>Scenario:</b><br>
                        B Ltd (12ä¸ªæœˆè´¦æœŸ) è´­ä¹°èµ„äº§ï¼š<br>
                        1. å…¨æ–°ç”Ÿäº§æœºå™¨ (Main Pool): Â£2,000,000<br>
                        2. äºŒæ‰‹åŠå…¬è®¾å¤‡ (Main Pool): Â£50,000<br>
                        3. å…¨æ–°ç©ºè°ƒç³»ç»Ÿ (SRP): Â£200,000<br>
                        <b>Requirement:</b> è®¡ç®—æœ€é«˜å¯æŠµæ‰£çš„ Capital Allowancesã€‚
                    `,
                    answer: `
                        <b>1. New Main Pool (Full Expensing)</b><br>
                        Â£2,000,000 Ã— 100% = <b>Â£2,000,000</b><br>
                        (æ— ä¸Šé™ï¼Œä¸å ç”¨ AIA)<br>
                        <br>
                        <b>2. Second-hand & SRP (Use AIA first)</b><br>
                        AIA Limit = Â£1,000,000<br>
                        ä¼˜å…ˆæŠµæ‰£ SRP (å› ä¸º SRP WDA åªæœ‰6%ï¼ŒæŠµæ‰£æ…¢)<br>
                        Allocated to SRP (Â£200,000) -> 100% covered<br>
                        Allocated to 2nd hand (Â£50,000) -> 100% covered<br>
                        Total AIA used = Â£250,000<br>
                        <br>
                        <b>Total Allowances = Â£2,250,000</b>
                    `,
                    note: 'ç­–ç•¥ï¼šFull Expensing æ˜¯æ— é™é¢çš„ï¼Œæ‰€ä»¥ AIA åº”è¯¥ç•™ç»™é‚£äº›ä¸èƒ½äº«å— Full Expensing çš„èµ„äº§ï¼ˆå¦‚äºŒæ‰‹èµ„äº§ï¼‰æˆ–è€…äº«å—æ¯”ä¾‹ä½çš„èµ„äº§ï¼ˆå¦‚ SRP èµ„äº§ï¼‰ã€‚'
                }
            },

            // --- CGT ---
            {
                id: '6', name: 'CGT: Individuals\nèµ„æœ¬åˆ©å¾—', category: 2, symbolSize: 70,
                color: '#a29bfe',
                info: {
                    def: 'ä¸ªäººèµ„äº§å¤„ç½® (FA24)',
                    rule: 'AEA: Â£3,000<br>Residential Rates: 18% / 24% (FA24æ–°è§„)<br>Other: 10% / 20%',
                    question: `
                        <b>Scenario:</b><br>
                        é«˜æ”¶å…¥è€… (Higher Rate Taxpayer) å‡ºå”®ï¼š<br>
                        1. æŠ•èµ„æˆ¿äº§ (Residential): Gain Â£40,000<br>
                        2. è‚¡ç¥¨ (Shares): Gain Â£10,000<br>
                        <b>Requirement:</b> è®¡ç®— 2023/24 CGTã€‚
                    `,
                    answer: `
                        <b>1. Allocate AEA (Â£3,000)</b><br>
                        ä¼˜å…ˆæŠµæ‰£ç¨ç‡æœ€é«˜çš„èµ„äº§ (Residential @ 24%)ã€‚<br>
                        Resi Taxable = 40,000 - 3,000 = Â£37,000<br>
                        Shares Taxable = Â£10,000<br>
                        <br>
                        <b>2. Calculate Tax</b><br>
                        Resi: Â£37,000 Ã— 24% = Â£8,880<br>
                        Shares: Â£10,000 Ã— 20% = Â£2,000<br>
                        <br>
                        <b>Total CGT = Â£10,880</b>
                    `,
                    note: 'ä½å®…æˆ¿äº§é«˜ç¨ç‡æ˜¯ 24% (FA24)ï¼Œä¸æ˜¯ 28%ï¼è¿™æ˜¯å¾ˆå¤šè€ƒç”Ÿçš„ç›²ç‚¹ã€‚'
                }
            },
            {
                id: '7', name: 'BADR\nå•†ä¸šèµ„äº§ä¼˜æƒ ', category: 2, symbolSize: 50,
                color: '#6c5ce7',
                info: {
                    def: 'Business Asset Disposal Relief',
                    rule: 'Tax Rate: 10%<br>Lifetime Limit: Â£1m',
                    question: `
                        <b>Scenario:</b><br>
                        å¼ å…ˆç”Ÿå‡ºå”®ç»è¥äº†5å¹´çš„ä¸ªäººå…¬å¸ï¼Œè·åˆ© Â£1.2 millionã€‚<br>ä»–ä¹‹å‰ä»æœªç”¨è¿‡ BADRã€‚<br>
                        <b>Requirement:</b> è®¡ç®— CGTã€‚
                    `,
                    answer: `
                        <b>BADR Calculation:</b><br>
                        Limit = Â£1,000,000<br>
                        1. é¦– Â£1m @ 10% = Â£100,000<br>
                        <br>
                        2. å‰©ä½™ Â£200k (1.2m - 1m):<br>
                        éœ€æŒ‰æ™®é€šç¨ç‡ (å‡è®¾é«˜æ”¶å…¥: 20%)<br>
                        Â£200,000 Ã— 20% = Â£40,000<br>
                        <br>
                        *AEA Â£3,000 å¯æŠµæ‰£é‚£ Â£200k çš„ä¸€éƒ¨åˆ†*<br>
                        ä¿®æ­£åç¬¬2æ­¥: (200k - 3k) Ã— 20% = Â£39,400<br>
                        <br>
                        <b>Total CGT = Â£139,400</b>
                    `,
                    note: 'BADR çš„ 10% ä¼˜æƒ ä»…é™å‰ Â£100 ä¸‡ï¼Œè¶…å‡ºçš„éƒ¨åˆ†å›å½’æ­£å¸¸ç¨ç‡ (10%/20%)ã€‚'
                }
            },

            // --- VAT ---
            {
                id: '8', name: 'VAT: Admin\nå¢å€¼ç¨ç®¡ç†', category: 3, symbolSize: 60,
                color: '#ffeaa7',
                info: {
                    def: 'Registration & Output Tax',
                    rule: 'Reg Threshold: Â£90,000 (FA24)<br>Discounts: Base VAT on actual payment',
                    question: `
                        <b>Scenario:</b><br>
                        C Ltd é”€å”®å•†å“æ ‡ä»· Â£1,000 (Net)ã€‚<br>æä¾› 5% æ—©æœŸä»˜æ¬¾æŠ˜æ‰£ (PPD)ã€‚<br>å®¢æˆ·æœ€ç»ˆé€‰æ‹©äº†ä»˜æ¬¾ï¼Œäº«å—äº†æŠ˜æ‰£ã€‚<br>
                        <b>Requirement:</b> è®¡ç®— Output VATã€‚
                    `,
                    answer: `
                        <b>Rule:</b> VAT å¿…é¡»åŸºäºå®¢æˆ·å®é™…æ”¯ä»˜çš„é‡‘é¢è®¡ç®—ã€‚<br>
                        <br>
                        Discounted Price = Â£1,000 Ã— 95% = Â£950<br>
                        Output VAT = Â£950 Ã— 20% = <b>Â£190</b><br>
                        <br>
                        (Total Invoice Value shown = Â£950 + Â£190 = Â£1,140)
                    `,
                    note: 'å¦‚æœå®¢æˆ·<b>æ²¡æœ‰</b>äº«å—æŠ˜æ‰£ï¼ˆä»˜äº†å…¨æ¬¾ï¼‰ï¼Œé‚£ä¹ˆ VAT å°±æ˜¯ Â£1,000 Ã— 20% = Â£200ã€‚VAT å–å†³äºå®é™…æ”¶äº†å¤šå°‘é’±ã€‚'
                }
            },

            // --- IHT ---
            {
                id: '9', name: 'IHT: Death Tax\né—äº§ç¨è®¡ç®—', category: 4, symbolSize: 60,
                color: '#55efc4',
                info: {
                    def: 'Death Estate Calculation',
                    rule: 'NRB: Â£325k / RNRB: Â£175k<br>Rate: 40%',
                    question: `
                        <b>Scenario:</b><br>
                        æå…ˆç”Ÿå»ä¸–ï¼Œé—äº§å¦‚ä¸‹ï¼š<br>
                        â€¢ è‡ªä½æˆ¿äº§ (ç•™ç»™å„¿å­): Â£450,000<br>
                        â€¢ è‚¡ç¥¨æŠ•èµ„: Â£300,000<br>
                        â€¢ ç”Ÿå‰ 7 å¹´å†…æ— èµ ä¸ã€‚<br>
                        <b>Requirement:</b> è®¡ç®— IHTã€‚
                    `,
                    answer: `
                        <b>1. Exemptions</b><br>
                        NRB = Â£325,000<br>
                        RNRB = Â£175,000 (é€‚ç”¨ï¼Œå› ä¸ºæœ‰æˆ¿ä¸”ç•™ç»™ç›´ç³»)<br>
                        Total Exempt = Â£500,000<br>
                        <br>
                        <b>2. Chargeable Estate</b><br>
                        Total Value = 450k + 300k = Â£750,000<br>
                        Taxable = 750,000 - 500,000 = Â£250,000<br>
                        <br>
                        <b>3. Tax</b><br>
                        Â£250,000 Ã— 40% = <b>Â£100,000</b>
                    `,
                    note: 'RNRB åªæœ‰åœ¨æˆ¿å­ç•™ç»™ç›´ç³»åä»£ (Direct Descendants) æ—¶æ‰å¯ç”¨ã€‚å¦‚æœç•™ç»™ä¾„å­æˆ–å…„å¼Ÿï¼Œå°±æ²¡æœ‰è¿™ Â£175k äº†ã€‚'
                }
            }
        ];

        // è¿æ¥å…³ç³» (æ˜Ÿç³»ç»“æ„)
        const links = [
            { source: 'root', target: 'it_main' },
            { source: 'it_main', target: 'it_pa' }, { source: 'it_main', target: 'it_nic' }, { source: 'it_main', target: 'it_emp' },
            { source: 'root', target: 'ct_main' },
            { source: 'ct_main', target: 'ct_ca' }, { source: 'ct_main', target: 'ct_loss' },
            { source: 'root', target: 'cgt_main' },
            { source: 'cgt_main', target: 'cgt_badr' },
            { source: 'root', target: 'iht_main' },
            { source: 'iht_main', target: 'iht_life' }, // éœ€è¦è¡¥ä¸€ä¸ª iht_life èŠ‚ç‚¹
            { source: 'root', target: 'vat_main' }
        ];

        // å›¾è¡¨é…ç½®
        option = {
            backgroundColor: '#fdfbf7',
            series: [
                {
                    type: 'graph',
                    layout: 'force',
                    data: dataPoints,
                    links: links,
                    roam: true,
                    draggable: true,
                    zoom: 0.85,
                    label: {
                        show: true,
                        position: 'bottom',
                        color: '#636e72',
                        fontSize: 11,
                        fontWeight: 'bold',
                        formatter: '{b}'
                    },
                    itemStyle: {
                        borderColor: '#fff',
                        borderWidth: 3,
                        shadowBlur: 10,
                        shadowColor: 'rgba(0,0,0,0.1)'
                    },
                    lineStyle: {
                        color: '#dcdde1',
                        curveness: 0.1,
                        width: 2
                    },
                    force: {
                        repulsion: 500,
                        edgeLength: 120,
                        gravity: 0.08
                    }
                }
            ]
        };

        myChart.setOption(option);
        window.addEventListener('resize', function() { myChart.resize(); });

        // ================= äº¤äº’é€»è¾‘ =================
        const overlay = document.getElementById('overlay');
        const sheet = document.getElementById('sheet');
        
        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        myChart.on('click', function(params) {
            if (params.data.info) {
                openSheet(params.data);
            }
        });

        function openSheet(node) {
            const info = node.info;
            const color = node.color;

            // æ³¨å…¥å¤´éƒ¨
            document.getElementById('nodeTitle').innerText = node.name.replace('\n', ' ');
            document.getElementById('nodeTitle').style.color = color;

            // æ³¨å…¥å†…å®¹
            let html = '';
            
            // 1. æ ¸å¿ƒå®šä¹‰ & è§„åˆ™
            html += `
                <div class="section">
                    <div class="section-title">CORE KNOWLEDGE</div>
                    <div class="text-box">
                        <strong>ğŸ’¡ Definition:</strong><br>${info.def}<br><br>
                        <strong>ğŸ“ Key Rules (FA24):</strong><br>${info.rule}
                    </div>
                </div>
            `;

            // 2. ç»¼åˆå¤§é¢˜ (æ ¸å¿ƒå‡çº§)
            if (info.question) {
                html += `
                    <div class="section">
                        <div class="section-title" style="color:#e17055">ğŸ”¥ COMPREHENSIVE EXAMPLE</div>
                        <div class="exam-card">
                            <div class="exam-header">
                                <span class="exam-icon">ğŸ“</span>
                                <span class="exam-title">Exam Standard Question</span>
                            </div>
                            <div class="exam-content">
                                ${info.question}
                                <details>
                                    <summary>ç‚¹å‡»æŸ¥çœ‹è§£æ & è®²å¸ˆæ¿ä¹¦</summary>
                                    <div class="answer-box">${info.answer}</div>
                                    <div class="lecturer-note">ğŸ‘©â€ğŸ« <b>Lecturer's Note:</b><br>${info.note}</div>
                                </details>
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('nodeContent').innerHTML = html;
            
            // æ˜¾ç¤ºå¼¹çª—
            overlay.classList.add('active');
            sheet.classList.add('active');
        }

        function closeSheet() {
            overlay.classList.remove('active');
            sheet.classList.remove('active');
        }
    </script>
</body>
</html>
